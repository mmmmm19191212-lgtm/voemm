<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta name="google-site-verification" content="9dKo9zsCt0_am-Dh_u50Vx9nK2n9XD9A9qutpGgJcW4" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨ÛŒØ³ÛŒÙ… - Ú†Øª ØµÙˆØªÛŒ Ø²Ù†Ø¯Ù‡</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <div>
  <h1 class="gradient-text">Ú†Øª ØµÙˆØªÛŒ Ø²Ù†Ø¯Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù†</h1>

<p style="color:#2aeb0c;">
  Ø¨Ø§ Ø¨ÛŒØ³ÛŒÙ… Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù‡Ù…â€ŒØ²Ù…Ø§Ù† Ø¨Ø§ Ø¯ÙˆØ³ØªØ§Ù†Øª Ú†Øª ØµÙˆØªÛŒ Ú©Ù†ÛŒ
</p>

<p style="color:#2aeb0c;">
  Ø§ÛŒØ¯ÛŒ Ø³Ø§Ø²Ù†Ø¯Ù‡ Ø¬Ù‡Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ùˆ Ø§Ù†ØªÙ‚Ø§Ø¯ Ù‡Ø§ 
  <a href="https://t.me/Mamad_NOX_YT" style="color:#00aaff;">
    VOEMIR
  </a>
</p>
</div>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Vazirmatn', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }
        
        .radio-wave {
            position: absolute;
            border-radius: 50%;
            border: 2px solid rgba(0, 255, 136, 0.3);
            animation: wave 2s infinite;
        }
        
        @keyframes wave {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }
        
        .pulse-ring {
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(0, 255, 136, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
        }
        .gradient-text {
             background: linear-gradient(90deg, #00ff88, #00aaff, #ff2d95);
            -webkit-background-clip: text;
            background-clip: text;
             -webkit-text-fill-color: transparent;
            font-size: 32px;
            font-weight: bold;}
        
        
        .audio-bar {
            width: 4px;
            background: linear-gradient(to top, #00ff88, #00d4ff);
            border-radius: 2px;
            animation: audio-wave 0.5s ease-in-out infinite alternate;
        }
        
        @keyframes audio-wave {
            from { height: 8px; }
            to { height: 32px; }
        }
        
        .glow-button {
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.4);
            transition: all 0.3s ease;
        }
        
        .glow-button:hover {
            box-shadow: 0 0 50px rgba(0, 255, 136, 0.6);
            transform: scale(1.02);
        }
        
        .glow-button:active {
            transform: scale(0.98);
        }
        
        .glow-button.muted {
            background: linear-gradient(to right, #ef4444, #dc2626) !important;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
        }
        
        .user-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .talking {
            border-color: #00ff88 !important;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }
        
        .control-btn {
            transition: all 0.2s ease;
        }
        
        .control-btn:hover {
            transform: scale(1.1);
        }
        
        .control-btn:active {
            transform: scale(0.95);
        }
        
        .control-btn.active {
            background: rgba(0, 255, 136, 0.2) !important;
            border-color: #00ff88 !important;
            color: #00ff88 !important;
        }
        
        .control-btn.muted {
            background: rgba(239, 68, 68, 0.2) !important;
            border-color: #ef4444 !important;
            color: #ef4444 !important;
        }
        
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type=number] {
            -moz-appearance: textfield;
            -webkit-appearance: none;
            appearance: textfield;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.2);
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00ff88;
            cursor: pointer;
        }
        
        .chat-tab {
            transition: all 0.2s ease;
        }
        
        .chat-tab:not(.active) {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.2);
            color: #9ca3af;
        }
        
        .chat-tab:not(.active):hover {
            background: rgba(255,255,255,0.1);
        }
        
        .chat-tab.has-unread {
            animation: unread-pulse 2s infinite;
        }
        
        @keyframes unread-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(0, 255, 136, 0); }
        }
        
        .chat-messages {
            display: none;
        }
        
        .chat-messages.active {
            display: block;
        }
        
        .message-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .user-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .user-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .user-item.selected {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00ff88;
        }
        
        .unread-badge {
            min-width: 20px;
            height: 20px;
            font-size: 11px;
        }
        
        .private-tab-close {
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .chat-tab:hover .private-tab-close {
            opacity: 1;
        }
    </style>
</head>
<body class="text-white">
    <!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ -->
    <div id="joinPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full">
            <!-- Ù„ÙˆÚ¯Ùˆ Ùˆ Ø¹Ù†ÙˆØ§Ù† -->
            <div class="text-center mb-8">
                <div class="relative inline-block mb-6">
                    <div class="w-24 h-24 bg-gradient-to-br from-green-400 to-cyan-500 rounded-full flex items-center justify-center">
                        <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                    </div>
                    <div class="radio-wave w-24 h-24 top-0 left-0"></div>
                    <div class="radio-wave w-24 h-24 top-0 left-0" style="animation-delay: 0.5s;"></div>
                    <div class="radio-wave w-24 h-24 top-0 left-0" style="animation-delay: 1s;"></div>
                </div>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-green-400 to-cyan-500 bg-clip-text text-transparent">
                    Ø¨ÛŒØ³ÛŒÙ…
                </h1>
                <p class="text-gray-400 mt-2">Ú†Øª ØµÙˆØªÛŒ Ø²Ù†Ø¯Ù‡ Ùˆ Ø±Ø§ÛŒÚ¯Ø§Ù†</p>
            </div>
            
            <!-- ÙØ±Ù… ÙˆØ±ÙˆØ¯ -->
            <div class="bg-white/5 backdrop-blur-xl rounded-2xl p-6 border border-white/10">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Ú©Ø¯ Ú©Ø§Ù†Ø§Ù„ (Û¶ ØªØ§ Û±Û² Ø±Ù‚Ù…)</label>
                    <input 
                        type="number" 
                        id="channelCode" 
                        placeholder="Ù…Ø«Ø§Ù„: 123456"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white text-center text-xl tracking-widest focus:outline-none focus:border-green-400 focus:ring-2 focus:ring-green-400/20 transition-all"
                        minlength="6"
                        maxlength="12"
                    >
                    <p id="codeError" class="text-red-400 text-sm mt-2 hidden">Ú©Ø¯ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û¶ ØªØ§ Û±Û² Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯</p>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Ù†Ø§Ù… Ø´Ù…Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                    <input 
                        type="text" 
                        id="userName" 
                        placeholder="Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-green-400 focus:ring-2 focus:ring-green-400/20 transition-all"
                        maxlength="20"
                    >
                </div>
                
                <button 
                    id="joinBtn"
                    class="w-full py-4 bg-gradient-to-r from-green-500 to-cyan-500 rounded-xl font-bold text-lg glow-button"
                >
                    ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„
                </button>
                
                <div class="mt-4 text-center">
                    <button 
                        id="randomChannel"
                        class="text-gray-400 hover:text-green-400 text-sm transition-colors"
                    >
                        âœ¨ Ø³Ø§Ø®Øª Ú©Ø¯ ØªØµØ§Ø¯ÙÛŒ
                    </button>
                </div>
            </div>
            
            <!-- Ø±Ø§Ù‡Ù†Ù…Ø§ -->
            <div class="mt-6 text-center text-gray-500 text-sm">
                <p>Ø¨Ø±Ø§ÛŒ ØµØ­Ø¨Øª Ø¨Ø§ Ø¯ÙˆØ³ØªØ§Ù†ØŒ Ù‡Ù…Ø§Ù† Ú©Ø¯ Ø±Ø§ Ø¨Ù‡ Ø¢Ù†Ù‡Ø§ Ø¨Ø¯Ù‡ÛŒØ¯</p>
            </div>
        </div>
    </div>
    
    <!-- ØµÙØ­Ù‡ Ú†Øª -->
    <div id="chatPage" class="min-h-screen flex flex-col hidden">
        <!-- Ù‡Ø¯Ø± -->
        <header class="bg-white/5 backdrop-blur-xl border-b border-white/10 p-4">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-400 to-cyan-500 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="font-bold">Ú©Ø§Ù†Ø§Ù„: <span id="displayChannel" class="text-green-400"></span></p>
                        <p class="text-sm text-gray-400"><span id="userCount">0</span> Ù†ÙØ± Ø¢Ù†Ù„Ø§ÛŒÙ†</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button 
                        id="changeChannelBtn"
                        class="px-3 py-2 bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/50 rounded-lg text-blue-400 transition-all text-sm"
                        title="ØªØºÛŒÛŒØ± Ú©Ø§Ù†Ø§Ù„"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                        </svg>
                    </button>
                    
                    <button 
                        id="leaveBtn"
                        class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded-lg text-red-400 transition-all"
                    >
                        Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ - Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ú†Øª -->
        <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
            <!-- Ø³ØªÙˆÙ† Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
            <div class="lg:w-64 p-4 border-b lg:border-b-0 lg:border-l border-white/10 overflow-auto">
                <h3 class="text-gray-400 text-sm mb-3 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                    </svg>
                    Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
                </h3>
                <div id="usersList" class="space-y-2">
                </div>
            </div>
            
            <!-- Ø³ØªÙˆÙ† Ú†Øª -->
            <div class="flex-1 flex flex-col min-h-0">
                <!-- ØªØ¨â€ŒÙ‡Ø§ÛŒ Ú†Øª -->
                <div class="flex items-center gap-2 p-3 bg-white/5 border-b border-white/10 overflow-x-auto">
                    <button 
                        id="publicChatTab"
                        class="chat-tab active px-4 py-2 rounded-lg bg-green-500/20 border border-green-500/50 text-green-400 text-sm whitespace-nowrap transition-all"
                    >
                        ğŸ’¬ Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ
                    </button>
                    <div id="privateChatTabs" class="flex gap-2">
                        <!-- ØªØ¨â€ŒÙ‡Ø§ÛŒ Ú†Øª Ø®ØµÙˆØµÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                    </div>
                </div>
                
                <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
                <div id="messagesContainer" class="flex-1 overflow-auto p-4 space-y-3">
                    <div id="publicMessages" class="chat-messages space-y-3">
                        <div class="text-center text-gray-500 text-sm py-8">
                            <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            Ø¨Ù‡ Ú†Øª Ú©Ø§Ù†Ø§Ù„ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!
                        </div>
                    </div>
                    <!-- Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                </div>
                
                <!-- ÙØ±Ù… Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… -->
                <div class="p-3 bg-white/5 border-t border-white/10">
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."
                            class="flex-1 px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-green-400 focus:ring-2 focus:ring-green-400/20 transition-all"
                            maxlength="500"
                        >
                        <button 
                            id="sendMessageBtn"
                            class="px-6 py-3 bg-gradient-to-r from-green-500 to-cyan-500 rounded-xl font-medium hover:opacity-90 transition-all"
                        >
                            <svg class="w-5 h-5 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                    <p id="chatTarget" class="text-xs text-gray-500 mt-2">Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡: Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ</p>
                </div>
            </div>
        </div>
        
        <!-- Ù†Ø´Ø§Ù†Ú¯Ø± ØµØ¯Ø§ -->
        <div id="audioIndicator" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 backdrop-blur-xl rounded-2xl p-8 border border-green-500/50">
            <div class="flex items-center gap-2 justify-center mb-4">
                <div class="audio-bar" style="animation-delay: 0s;"></div>
                <div class="audio-bar" style="animation-delay: 0.1s;"></div>
                <div class="audio-bar" style="animation-delay: 0.2s;"></div>
                <div class="audio-bar" style="animation-delay: 0.3s;"></div>
                <div class="audio-bar" style="animation-delay: 0.4s;"></div>
            </div>
            <p class="text-green-400 text-center font-medium">Ø¯Ø± Ø­Ø§Ù„ ØµØ­Ø¨Øª...</p>
        </div>
        
        <!-- Ù¾Ù†Ù„ Ú©Ù†ØªØ±Ù„ -->
        <div class="p-6 bg-white/5 backdrop-blur-xl border-t border-white/10">
            <div class="max-w-4xl mx-auto">
                <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ -->
                <div class="flex justify-center items-center gap-6 mb-6">
                    <!-- Ø¯Ú©Ù…Ù‡ Mute Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† -->
                    <button 
                        id="micBtn"
                        class="control-btn w-14 h-14 rounded-full bg-white/10 border border-white/20 flex items-center justify-center active"
                        title="Ù‚Ø·Ø¹/ÙˆØµÙ„ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†"
                    >
                        <svg id="micOnIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                        <svg id="micOffIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>
                        </svg>
                    </button>
                    
                    <!-- Ø¯Ú©Ù…Ù‡ Push-to-Talk -->
                    <button 
                        id="pttBtn"
                        class="w-24 h-24 rounded-full bg-gradient-to-br from-green-500 to-cyan-500 flex items-center justify-center glow-button relative"
                    >
                        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                        <div id="pttRing" class="absolute inset-0 rounded-full border-4 border-green-400 hidden pulse-ring"></div>
                    </button>
                    
                    <!-- Ø¯Ú©Ù…Ù‡ Mute Ø§Ø³Ù¾ÛŒÚ©Ø± -->
                    <button 
                        id="speakerBtn"
                        class="control-btn w-14 h-14 rounded-full bg-white/10 border border-white/20 flex items-center justify-center active"
                        title="Ù‚Ø·Ø¹/ÙˆØµÙ„ ØµØ¯Ø§"
                    >
                        <svg id="speakerOnIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                        </svg>
                        <svg id="speakerOffIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Ú©Ù†ØªØ±Ù„ ÙˆÙ„ÙˆÙ… -->
                <div class="flex items-center justify-center gap-4 mb-4">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                    </svg>
                    <input 
                        type="range" 
                        id="volumeSlider" 
                        min="0" 
                        max="100" 
                        value="100"
                        class="volume-slider w-32"
                    >
                    <span id="volumeValue" class="text-gray-400 text-sm w-10">100%</span>
                </div>
                
                <p id="pttHint" class="text-gray-400 text-sm text-center">Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯ Ùˆ ØµØ­Ø¨Øª Ú©Ù†ÛŒØ¯ (ÛŒØ§ Ú©Ù„ÛŒØ¯ Space)</p>
                
                <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
                <div class="mt-4 flex items-center justify-center gap-4">
                    <label class="flex items-center gap-2 text-sm text-gray-400 cursor-pointer">
                        <input type="checkbox" id="continuousMode" class="w-4 h-4 rounded accent-green-500">
                        Ø­Ø§Ù„Øª Ù¾ÛŒÙˆØ³ØªÙ‡ (Ø¨Ø¯ÙˆÙ† Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ†)
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Ù†ÙˆØ§Ø± ÙˆØ¶Ø¹ÛŒØª -->
        <div id="statusBar" class="bg-green-500/20 border-t border-green-500/30 p-2 text-center text-sm text-green-400">
            <span id="statusText">Ù…ØªØµÙ„</span>
        </div>
    </div>
    
    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØºÛŒÛŒØ± Ú©Ø§Ù†Ø§Ù„ -->
    <div id="changeChannelModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 rounded-2xl p-6 max-w-sm w-full border border-blue-500/30 slide-up">
            <div class="text-center">
                <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold mb-4">ØªØºÛŒÛŒØ± Ú©Ø§Ù†Ø§Ù„</h3>
                
                <div class="mb-4">
                    <input 
                        type="number" 
                        id="newChannelCode" 
                        placeholder="Ú©Ø¯ Ú©Ø§Ù†Ø§Ù„ Ø¬Ø¯ÛŒØ¯"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white text-center text-xl tracking-widest focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-400/20 transition-all"
                    >
                    <p id="newCodeError" class="text-red-400 text-sm mt-2 hidden">Ú©Ø¯ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† Û¶ ØªØ§ Û±Û² Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯</p>
                </div>
                
                <div class="flex gap-3">
                    <button id="confirmChangeChannel" class="flex-1 px-4 py-3 bg-blue-500 hover:bg-blue-600 rounded-xl font-medium transition-colors">
                        ØªØºÛŒÛŒØ±
                    </button>
                    <button id="cancelChangeChannel" class="flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-medium transition-colors">
                        Ø§Ù†ØµØ±Ø§Ù
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø®Ø·Ø§ -->
    <div id="errorModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 rounded-2xl p-6 max-w-sm w-full border border-red-500/30">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold mb-2">Ø®Ø·Ø§</h3>
                <p id="errorMessage" class="text-gray-400 mb-6"></p>
                <button id="closeError" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                    Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…
                </button>
            </div>
        </div>
    </div>

    <script>
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª
        const SAMPLE_RATE = 16000;
        const BUFFER_SIZE = 4096;
        
        // Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ±
        const getServerUrl = () => {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            return `${protocol}//${host}/ws`;
        };

        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ú¯Ù„ÙˆØ¨Ø§Ù„
        let ws = null;
        let audioContext = null;
        let mediaStream = null;
        let scriptProcessor = null;
        let sourceNode = null;
        let isRecording = false;
        let channelCode = '';
        let userName = '';
        let userId = Math.random().toString(36).substr(2, 9);
        let users = new Map();
        let isMicMuted = false;
        let isSpeakerMuted = false;
        let volume = 1;
        let shouldReconnect = true;
        let playbackContext = null;

        // Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§
        const joinPage = document.getElementById('joinPage');
        const chatPage = document.getElementById('chatPage');
        const channelInput = document.getElementById('channelCode');
        const userNameInput = document.getElementById('userName');
        const joinBtn = document.getElementById('joinBtn');
        const randomChannelBtn = document.getElementById('randomChannel');
        const leaveBtn = document.getElementById('leaveBtn');
        const changeChannelBtn = document.getElementById('changeChannelBtn');
        const pttBtn = document.getElementById('pttBtn');
        const pttRing = document.getElementById('pttRing');
        const pttHint = document.getElementById('pttHint');
        const audioIndicator = document.getElementById('audioIndicator');
        const displayChannel = document.getElementById('displayChannel');
        const userCount = document.getElementById('userCount');
        const usersList = document.getElementById('usersList');
        const statusText = document.getElementById('statusText');
        const statusBar = document.getElementById('statusBar');
        const continuousMode = document.getElementById('continuousMode');
        const codeError = document.getElementById('codeError');
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const closeError = document.getElementById('closeError');
        
        const micBtn = document.getElementById('micBtn');
        const micOnIcon = document.getElementById('micOnIcon');
        const micOffIcon = document.getElementById('micOffIcon');
        const speakerBtn = document.getElementById('speakerBtn');
        const speakerOnIcon = document.getElementById('speakerOnIcon');
        const speakerOffIcon = document.getElementById('speakerOffIcon');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        
        const changeChannelModal = document.getElementById('changeChannelModal');
        const newChannelCode = document.getElementById('newChannelCode');
        const newCodeError = document.getElementById('newCodeError');
        const confirmChangeChannel = document.getElementById('confirmChangeChannel');
        const cancelChangeChannel = document.getElementById('cancelChangeChannel');
        
        // Ú†Øª
        const publicChatTab = document.getElementById('publicChatTab');
        const privateChatTabs = document.getElementById('privateChatTabs');
        const messagesContainer = document.getElementById('messagesContainer');
        const publicMessages = document.getElementById('publicMessages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const chatTarget = document.getElementById('chatTarget');
        
        // Ø°Ø®ÛŒØ±Ù‡ Ú†Øªâ€ŒÙ‡Ø§
        let currentChatTarget = 'public'; // 'public' ÛŒØ§ ID Ú©Ø§Ø±Ø¨Ø±
        let privateChats = new Map(); // userId -> {messages: [], unread: 0}
        let openPrivateTabs = new Set();

        // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ú©Ø¯ Ú©Ø§Ù†Ø§Ù„
        function validateCode(code) {
            const codeStr = code.toString();
            return codeStr.length >= 6 && codeStr.length <= 12 && /^\d+$/.test(codeStr);
        }

        // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§
        function showError(message) {
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
        }

        closeError.onclick = () => errorModal.classList.add('hidden');

        // ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ ØªØµØ§Ø¯ÙÛŒ
        randomChannelBtn.onclick = () => {
            const randomCode = Math.floor(100000 + Math.random() * 900000);
            channelInput.value = randomCode;
        };

        // ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„
        joinBtn.onclick = async () => {
            channelCode = channelInput.value.trim();
            userName = userNameInput.value.trim() || 'Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†';
            
            if (!validateCode(channelCode)) {
                codeError.classList.remove('hidden');
                return;
            }
            codeError.classList.add('hidden');
            
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: SAMPLE_RATE
                    } 
                });
                shouldReconnect = true;
                connectWebSocket();
            } catch (err) {
                showError('Ù„Ø·ÙØ§Ù‹ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯');
            }
        };

        // Ø§ØªØµØ§Ù„ WebSocket
        function connectWebSocket() {
            const serverUrl = getServerUrl();
            ws = new WebSocket(`${serverUrl}/${channelCode}/${userId}/${encodeURIComponent(userName)}`);
            
            ws.binaryType = 'arraybuffer';
            
            ws.onopen = () => {
                console.log('Connected to server');
                joinPage.classList.add('hidden');
                chatPage.classList.remove('hidden');
                displayChannel.textContent = channelCode;
                setStatus('Ù…ØªØµÙ„', 'green');
                initAudio();
            };
            
            ws.onmessage = async (event) => {
                if (typeof event.data === 'string') {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } else {
                    // Ø¯Ø§Ø¯Ù‡ ØµÙˆØªÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡
                    if (!isSpeakerMuted) {
                        playAudioData(event.data);
                    }
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
            
            ws.onclose = () => {
                console.log('Disconnected from server');
                setStatus('Ù‚Ø·Ø¹ Ø´Ø¯Ù‡', 'red');
                
                if (shouldReconnect && !chatPage.classList.contains('hidden')) {
                    setTimeout(() => {
                        if (channelCode && shouldReconnect) {
                            setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯...', 'yellow');
                            connectWebSocket();
                        }
                    }, 3000);
                }
            };
        }

        // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
        function handleMessage(data) {
            switch (data.type) {
                case 'users':
                    users.clear();
                    data.users.forEach(user => {
                        users.set(user.id, user);
                    });
                    updateUsersList();
                    break;
                    
                case 'join':
                    users.set(data.user.id, data.user);
                    updateUsersList();
                    // Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ…ÛŒ
                    addSystemMessage(`${data.user.name} ÙˆØ§Ø±Ø¯ Ú©Ø§Ù†Ø§Ù„ Ø´Ø¯`);
                    break;
                    
                case 'leave':
                    const leavingUser = users.get(data.userId);
                    users.delete(data.userId);
                    updateUsersList();
                    if (leavingUser) {
                        addSystemMessage(`${leavingUser.name} Ø§Ø² Ú©Ø§Ù†Ø§Ù„ Ø®Ø§Ø±Ø¬ Ø´Ø¯`);
                    }
                    break;
                    
                case 'talking':
                    setUserTalking(data.userId, data.isTalking);
                    break;
                    
                case 'chat':
                    // Ù¾ÛŒØ§Ù… Ú†Øª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡
                    addMessageToChat({
                        senderId: data.senderId,
                        senderName: data.senderName,
                        text: data.text,
                        isPrivate: data.isPrivate,
                        targetId: data.targetId,
                        isMe: false
                    });
                    break;
            }
        }
        
        // Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ…ÛŒ
        function addSystemMessage(text) {
            const div = document.createElement('div');
            div.className = 'text-center slide-up';
            div.innerHTML = `<span class="text-xs text-gray-500 bg-white/5 px-3 py-1 rounded-full">${text}</span>`;
            publicMessages.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        function updateUsersList() {
            usersList.innerHTML = '';
            userCount.textContent = users.size;
            
            users.forEach((user, id) => {
                const isMe = id === userId;
                const unread = privateChats.get(id)?.unread || 0;
                const div = document.createElement('div');
                div.id = `user-${id}`;
                div.className = `user-item user-card rounded-xl p-3 flex items-center gap-3 transition-all ${isMe ? 'border-cyan-500/50' : ''}`;
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br ${isMe ? 'from-cyan-400 to-blue-500' : 'from-gray-600 to-gray-700'} flex items-center justify-center text-lg font-bold flex-shrink-0">
                        ${user.name.charAt(0)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium truncate">${user.name}</p>
                        ${isMe ? '<p class="text-xs text-cyan-400">(Ø´Ù…Ø§)</p>' : '<p class="text-xs text-gray-500">Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ú†Øª Ø®ØµÙˆØµÛŒ</p>'}
                    </div>
                    ${!isMe && unread > 0 ? `<span class="unread-badge bg-green-500 text-white rounded-full flex items-center justify-center font-bold">${unread}</span>` : ''}
                `;
                
                // Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ú†Øª Ø®ØµÙˆØµÛŒ
                if (!isMe) {
                    div.onclick = () => openPrivateChat(id, user.name);
                }
                
                usersList.appendChild(div);
            });
        }

        // Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø­Ø§Ù„ ØµØ­Ø¨Øª
        function setUserTalking(id, isTalking) {
            const userCard = document.getElementById(`user-${id}`);
            if (userCard) {
                if (isTalking) {
                    userCard.classList.add('talking');
                } else {
                    userCard.classList.remove('talking');
                }
            }
        }

        // ØªÙ†Ø¸ÛŒÙ… ÙˆØ¶Ø¹ÛŒØª
        function setStatus(text, color) {
            statusText.textContent = text;
            statusBar.className = `p-2 text-center text-sm border-t`;
            if (color === 'green') {
                statusBar.classList.add('bg-green-500/20', 'border-green-500/30', 'text-green-400');
            } else if (color === 'red') {
                statusBar.classList.add('bg-red-500/20', 'border-red-500/30', 'text-red-400');
            } else if (color === 'yellow') {
                statusBar.classList.add('bg-yellow-500/20', 'border-yellow-500/30', 'text-yellow-400');
            }
        }

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØµØ¯Ø§
        async function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: SAMPLE_RATE
                });
                
                playbackContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: SAMPLE_RATE
                });
                
                sourceNode = audioContext.createMediaStreamSource(mediaStream);
                scriptProcessor = audioContext.createScriptProcessor(BUFFER_SIZE, 1, 1);
                
                scriptProcessor.onaudioprocess = (e) => {
                    if (isRecording && ws && ws.readyState === WebSocket.OPEN && !isMicMuted) {
                        const inputData = e.inputBuffer.getChannelData(0);
                        // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Int16
                        const pcmData = new Int16Array(inputData.length);
                        for (let i = 0; i < inputData.length; i++) {
                            const s = Math.max(-1, Math.min(1, inputData[i]));
                            pcmData[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                        }
                        ws.send(pcmData.buffer);
                    }
                };
                
                // ÙˆØµÙ„ Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ ÙˆÙ‚ØªÛŒ PTT ÙØ´Ø±Ø¯Ù‡ Ù†Ø´Ø¯Ù‡
                
            } catch (err) {
                console.error('Error initializing audio:', err);
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØµØ¯Ø§');
            }
        }

        // Ù¾Ø®Ø´ ØµØ¯Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ
        function playAudioData(arrayBuffer) {
            try {
                if (!playbackContext) return;
                
                const int16Data = new Int16Array(arrayBuffer);
                const floatData = new Float32Array(int16Data.length);
                
                // ØªØ¨Ø¯ÛŒÙ„ Int16 Ø¨Ù‡ Float32
                for (let i = 0; i < int16Data.length; i++) {
                    floatData[i] = int16Data[i] / (int16Data[i] < 0 ? 0x8000 : 0x7FFF);
                }
                
                const audioBuffer = playbackContext.createBuffer(1, floatData.length, SAMPLE_RATE);
                audioBuffer.getChannelData(0).set(floatData);
                
                const source = playbackContext.createBufferSource();
                const gainNode = playbackContext.createGain();
                gainNode.gain.value = volume;
                
                source.buffer = audioBuffer;
                source.connect(gainNode);
                gainNode.connect(playbackContext.destination);
                source.start();
                
            } catch (err) {
                console.error('Error playing audio:', err);
            }
        }

        // Ø´Ø±ÙˆØ¹ Ø¶Ø¨Ø·
        function startRecording() {
            if (isMicMuted) {
                return;
            }
            
            if (audioContext && sourceNode && scriptProcessor) {
                isRecording = true;
                sourceNode.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);
                
                pttRing.classList.remove('hidden');
                audioIndicator.classList.remove('hidden');
                pttBtn.classList.add('scale-95');
                
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'talking', isTalking: true }));
                }
            }
        }

        // ØªÙˆÙ‚Ù Ø¶Ø¨Ø·
        function stopRecording() {
            if (isRecording) {
                isRecording = false;
                
                try {
                    scriptProcessor.disconnect();
                    sourceNode.disconnect();
                } catch(e) {}
                
                pttRing.classList.add('hidden');
                audioIndicator.classList.add('hidden');
                pttBtn.classList.remove('scale-95');
                
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'talking', isTalking: false }));
                }
            }
        }

        // Ú©Ù†ØªØ±Ù„ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†
        micBtn.onclick = () => {
            isMicMuted = !isMicMuted;
            
            if (isMicMuted) {
                micBtn.classList.remove('active');
                micBtn.classList.add('muted');
                micOnIcon.classList.add('hidden');
                micOffIcon.classList.remove('hidden');
                pttBtn.classList.add('muted');
                pttHint.textContent = 'Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø®Ø§Ù…ÙˆØ´ Ø§Ø³Øª';
                
                if (isRecording) {
                    stopRecording();
                }
            } else {
                micBtn.classList.add('active');
                micBtn.classList.remove('muted');
                micOnIcon.classList.remove('hidden');
                micOffIcon.classList.add('hidden');
                pttBtn.classList.remove('muted');
                pttHint.textContent = 'Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯ Ùˆ ØµØ­Ø¨Øª Ú©Ù†ÛŒØ¯ (ÛŒØ§ Ú©Ù„ÛŒØ¯ Space)';
            }
        };

        // Ú©Ù†ØªØ±Ù„ Ø§Ø³Ù¾ÛŒÚ©Ø±
        speakerBtn.onclick = () => {
            isSpeakerMuted = !isSpeakerMuted;
            
            if (isSpeakerMuted) {
                speakerBtn.classList.remove('active');
                speakerBtn.classList.add('muted');
                speakerOnIcon.classList.add('hidden');
                speakerOffIcon.classList.remove('hidden');
            } else {
                speakerBtn.classList.add('active');
                speakerBtn.classList.remove('muted');
                speakerOnIcon.classList.remove('hidden');
                speakerOffIcon.classList.add('hidden');
            }
        };

        // Ú©Ù†ØªØ±Ù„ ÙˆÙ„ÙˆÙ…
        volumeSlider.oninput = () => {
            volume = volumeSlider.value / 100;
            volumeValue.textContent = volumeSlider.value + '%';
        };

        // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø¯Ú©Ù…Ù‡ PTT
        pttBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            if (!continuousMode.checked) {
                startRecording();
            }
        });

        pttBtn.addEventListener('mouseup', (e) => {
            e.preventDefault();
            if (!continuousMode.checked) {
                stopRecording();
            }
        });

        pttBtn.addEventListener('mouseleave', (e) => {
            if (!continuousMode.checked && isRecording) {
                stopRecording();
            }
        });

        pttBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (!continuousMode.checked) {
                startRecording();
            }
        });

        pttBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            if (!continuousMode.checked) {
                stopRecording();
            }
        });

        pttBtn.addEventListener('click', () => {
            if (continuousMode.checked) {
                if (isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            }
        });

        // ØªØºÛŒÛŒØ± Ú©Ø§Ù†Ø§Ù„
        changeChannelBtn.onclick = () => {
            changeChannelModal.classList.remove('hidden');
            newChannelCode.value = '';
            newCodeError.classList.add('hidden');
            newChannelCode.focus();
        };

        cancelChangeChannel.onclick = () => {
            changeChannelModal.classList.add('hidden');
        };

        confirmChangeChannel.onclick = async () => {
            const newCode = newChannelCode.value.trim();
            
            if (!validateCode(newCode)) {
                newCodeError.classList.remove('hidden');
                return;
            }
            
            shouldReconnect = false;
            if (ws) {
                ws.close();
            }
            if (isRecording) {
                stopRecording();
            }
            
            channelCode = newCode;
            users.clear();
            updateUsersList();
            
            shouldReconnect = true;
            changeChannelModal.classList.add('hidden');
            setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...', 'yellow');
            
            setTimeout(() => {
                connectWebSocket();
            }, 500);
        };

        // Ø®Ø±ÙˆØ¬ Ø§Ø² Ú©Ø§Ù†Ø§Ù„
        leaveBtn.onclick = () => {
            shouldReconnect = false;
            
            if (ws) {
                ws.close();
            }
            if (isRecording) {
                stopRecording();
            }
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            if (audioContext) {
                audioContext.close();
            }
            if (playbackContext) {
                playbackContext.close();
            }
            
            channelCode = '';
            users.clear();
            isMicMuted = false;
            isSpeakerMuted = false;
            
            // Ø±ÛŒØ³Øª Ú†Øª
            currentChatTarget = 'public';
            privateChats.clear();
            openPrivateTabs.clear();
            privateChatTabs.innerHTML = '';
            publicMessages.innerHTML = `
                <div class="text-center text-gray-500 text-sm py-8">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    Ø¨Ù‡ Ú†Øª Ú©Ø§Ù†Ø§Ù„ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!
                </div>
            `;
            // Ø­Ø°Ù Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ
            document.querySelectorAll('.chat-messages:not(#publicMessages)').forEach(el => el.remove());
            publicMessages.classList.add('active');
            publicChatTab.classList.add('active');
            chatTarget.textContent = 'Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡: Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ';
            
            // Ø±ÛŒØ³Øª UI
            micBtn.classList.add('active');
            micBtn.classList.remove('muted');
            micOnIcon.classList.remove('hidden');
            micOffIcon.classList.add('hidden');
            speakerBtn.classList.add('active');
            speakerBtn.classList.remove('muted');
            speakerOnIcon.classList.remove('hidden');
            speakerOffIcon.classList.add('hidden');
            pttBtn.classList.remove('muted');
            pttHint.textContent = 'Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯ Ùˆ ØµØ­Ø¨Øª Ú©Ù†ÛŒØ¯ (ÛŒØ§ Ú©Ù„ÛŒØ¯ Space)';
            
            chatPage.classList.add('hidden');
            joinPage.classList.remove('hidden');
        };

        // Ú©Ù„ÛŒØ¯ Space Ø¨Ø±Ø§ÛŒ ØµØ­Ø¨Øª
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !chatPage.classList.contains('hidden') && !continuousMode.checked) {
                if (document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    if (!isRecording) {
                        startRecording();
                    }
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space' && !chatPage.classList.contains('hidden') && !continuousMode.checked) {
                if (document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    stopRecording();
                }
            }
        });

        // Enter Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯
        channelInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinBtn.click();
            }
        });

        newChannelCode.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                confirmChangeChannel.click();
            }
        });

        // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø¨ÛŒØ±ÙˆÙ†
        changeChannelModal.addEventListener('click', (e) => {
            if (e.target === changeChannelModal) {
                changeChannelModal.classList.add('hidden');
            }
        });
        
        // ===== Ø³ÛŒØ³ØªÙ… Ú†Øª =====
        
        // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ú†Øª Ø®ØµÙˆØµÛŒ
        function openPrivateChat(targetId, targetName) {
            // Ø§Ú¯Ø± ØªØ¨ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ù‡ØŒ Ø¨Ø³Ø§Ø²Ø´
            if (!openPrivateTabs.has(targetId)) {
                openPrivateTabs.add(targetId);
                
                // Ø§ÛŒØ¬Ø§Ø¯ ØªØ¨
                const tab = document.createElement('button');
                tab.id = `tab-${targetId}`;
                tab.className = 'chat-tab px-4 py-2 rounded-lg border text-sm whitespace-nowrap flex items-center gap-2';
                tab.innerHTML = `
                    <span>ğŸ”’ ${targetName}</span>
                    <span class="private-tab-close text-red-400 hover:text-red-300" onclick="event.stopPropagation(); closePrivateTab('${targetId}')">&times;</span>
                `;
                tab.onclick = () => switchToChat(targetId);
                privateChatTabs.appendChild(tab);
                
                // Ø§ÛŒØ¬Ø§Ø¯ container Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
                const messagesDiv = document.createElement('div');
                messagesDiv.id = `messages-${targetId}`;
                messagesDiv.className = 'chat-messages space-y-3';
                messagesDiv.innerHTML = `
                    <div class="text-center text-gray-500 text-sm py-4">
                        <span class="bg-white/10 px-3 py-1 rounded-full">Ø´Ø±ÙˆØ¹ Ú†Øª Ø®ØµÙˆØµÛŒ Ø¨Ø§ ${targetName}</span>
                    </div>
                `;
                messagesContainer.appendChild(messagesDiv);
                
                // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø± Map Ø§Ú¯Ø± Ù†Ø¨ÙˆØ¯
                if (!privateChats.has(targetId)) {
                    privateChats.set(targetId, { messages: [], unread: 0 });
                }
            }
            
            // Ø³ÙˆÛŒÛŒÚ† Ø¨Ù‡ Ø§ÛŒÙ† Ú†Øª
            switchToChat(targetId);
        }
        
        // Ø¨Ø³ØªÙ† ØªØ¨ Ú†Øª Ø®ØµÙˆØµÛŒ
        function closePrivateTab(targetId) {
            openPrivateTabs.delete(targetId);
            
            // Ø­Ø°Ù ØªØ¨
            const tab = document.getElementById(`tab-${targetId}`);
            if (tab) tab.remove();
            
            // Ø­Ø°Ù Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
            const messages = document.getElementById(`messages-${targetId}`);
            if (messages) messages.remove();
            
            // Ø§Ú¯Ø± Ø§ÛŒÙ† Ú†Øª ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯ØŒ Ø¨Ø±Ú¯Ø±Ø¯ Ø¨Ù‡ Ø¹Ù…ÙˆÙ…ÛŒ
            if (currentChatTarget === targetId) {
                switchToChat('public');
            }
        }
        
        // Ø³ÙˆÛŒÛŒÚ† Ø¨ÛŒÙ† Ú†Øªâ€ŒÙ‡Ø§
        function switchToChat(target) {
            currentChatTarget = target;
            
            // Ø¢Ù¾Ø¯ÛŒØª ØªØ¨â€ŒÙ‡Ø§
            document.querySelectorAll('.chat-tab').forEach(tab => {
                tab.classList.remove('active');
                if (target === 'public' && tab.id === 'publicChatTab') {
                    tab.classList.add('active');
                } else if (tab.id === `tab-${target}`) {
                    tab.classList.add('active');
                    tab.classList.remove('has-unread');
                }
            });
            
            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ·Ù‡
            document.querySelectorAll('.chat-messages').forEach(div => {
                div.classList.remove('active');
            });
            
            if (target === 'public') {
                publicMessages.classList.add('active');
                chatTarget.textContent = 'Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡: Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ';
            } else {
                const messagesDiv = document.getElementById(`messages-${target}`);
                if (messagesDiv) {
                    messagesDiv.classList.add('active');
                }
                const targetUser = users.get(target);
                chatTarget.textContent = `Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡: ${targetUser?.name || 'Ú©Ø§Ø±Ø¨Ø±'}`;
                
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† unread
                if (privateChats.has(target)) {
                    privateChats.get(target).unread = 0;
                    updateUsersList();
                }
            }
            
            // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            const message = {
                type: 'chat',
                text: text,
                isPrivate: currentChatTarget !== 'public',
                targetId: currentChatTarget !== 'public' ? currentChatTarget : null
            };
            
            ws.send(JSON.stringify(message));
            
            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯Ù…ÙˆÙ†
            addMessageToChat({
                senderId: userId,
                senderName: userName,
                text: text,
                isPrivate: message.isPrivate,
                targetId: message.targetId,
                isMe: true
            });
            
            messageInput.value = '';
        }
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú†Øª
        function addMessageToChat(msg) {
            const time = new Date().toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${msg.isMe ? 'justify-end' : 'justify-start'} slide-up`;
            
            const bubbleClass = msg.isMe 
                ? 'bg-gradient-to-r from-green-500 to-cyan-500' 
                : (msg.isPrivate ? 'bg-purple-600/80' : 'bg-white/10');
            
            messageDiv.innerHTML = `
                <div class="message-bubble ${bubbleClass} rounded-2xl px-4 py-2 ${msg.isMe ? 'rounded-br-md' : 'rounded-bl-md'}">
                    ${!msg.isMe ? `<p class="text-xs ${msg.isPrivate ? 'text-purple-300' : 'text-green-400'} mb-1">${msg.senderName} ${msg.isPrivate ? 'ğŸ”’' : ''}</p>` : ''}
                    <p class="text-white">${escapeHtml(msg.text)}</p>
                    <p class="text-xs ${msg.isMe ? 'text-white/70' : 'text-gray-400'} mt-1 text-left">${time}</p>
                </div>
            `;
            
            // Ú©Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒÙ…ØŸ
            let targetContainer;
            if (msg.isPrivate) {
                // Ú†Øª Ø®ØµÙˆØµÛŒ
                const chatPartnerId = msg.isMe ? msg.targetId : msg.senderId;
                targetContainer = document.getElementById(`messages-${chatPartnerId}`);
                
                // Ø§Ú¯Ø± ØªØ¨ Ø¨Ø§Ø² Ù†ÛŒØ³Øª Ùˆ Ù¾ÛŒØ§Ù… Ø§Ø² Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ø³Øª
                if (!msg.isMe && !openPrivateTabs.has(msg.senderId)) {
                    const sender = users.get(msg.senderId);
                    if (sender) {
                        openPrivateChat(msg.senderId, sender.name);
                    }
                }
                
                // Ø§ÙØ²Ø§ÛŒØ´ unread Ø§Ú¯Ø± Ú†Øª ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª
                if (!msg.isMe && currentChatTarget !== msg.senderId) {
                    if (!privateChats.has(msg.senderId)) {
                        privateChats.set(msg.senderId, { messages: [], unread: 0 });
                    }
                    privateChats.get(msg.senderId).unread++;
                    updateUsersList();
                    
                    // Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ØªØ¨
                    const tab = document.getElementById(`tab-${msg.senderId}`);
                    if (tab) tab.classList.add('has-unread');
                }
            } else {
                // Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ
                targetContainer = publicMessages;
            }
            
            if (targetContainer) {
                // Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯Ú¯ÙˆÛŒÛŒ Ø§Ú¯Ø± Ù‡Ø³Øª
                const welcome = targetContainer.querySelector('.text-center');
                if (welcome && targetContainer.children.length === 1) {
                    welcome.remove();
                }
                
                targetContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
        
        // escape HTML Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Event listeners Ø¨Ø±Ø§ÛŒ Ú†Øª
        sendMessageBtn.onclick = sendMessage;
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        publicChatTab.onclick = () => switchToChat('public');
        
        // Ù†Ù…Ø§ÛŒØ´ Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        publicMessages.classList.add('active');
    </script>
</body>
</html>