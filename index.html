<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù¾ÛŒØ§Ù…â€ŒØ±Ø³Ø§Ù† ØµÙˆØªÛŒ</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0f172a">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Vazirmatn', sans-serif;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            margin: 0;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glow-green { box-shadow: 0 0 30px rgba(34, 197, 94, 0.4); }
        .glow-blue { box-shadow: 0 0 30px rgba(59, 130, 246, 0.4); }
        .glow-red { box-shadow: 0 0 30px rgba(239, 68, 68, 0.4); }
        
        .slide-up { animation: slideUp 0.3s ease; }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        @keyframes ring {
            0%, 100% { transform: rotate(0deg); }
            20% { transform: rotate(15deg); }
            40% { transform: rotate(-15deg); }
            60% { transform: rotate(10deg); }
            80% { transform: rotate(-10deg); }
        }
        
        .animate-pulse-custom { animation: pulse 2s infinite; }
        .animate-ring { animation: ring 0.5s infinite; }
        
        .online-dot {
            width: 12px; height: 12px;
            background: #22c55e;
            border-radius: 50%;
            box-shadow: 0 0 8px #22c55e;
        }
        
        .offline-dot {
            width: 12px; height: 12px;
            background: #64748b;
            border-radius: 50%;
        }
        
        .unread-badge {
            min-width: 22px; height: 22px;
            background: linear-gradient(135deg, #ef4444, #f97316);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: bold;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.5);
        }
        
        .tab-btn.active {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #22c55e;
        }
        
        .message-bubble {
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .audio-wave {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .audio-wave span {
            width: 4px;
            background: linear-gradient(to top, #22c55e, #3b82f6);
            border-radius: 2px;
            animation: wave 0.5s ease-in-out infinite alternate;
        }
        
        @keyframes wave {
            from { height: 8px; }
            to { height: 28px; }
        }
        
        .audio-wave span:nth-child(1) { animation-delay: 0s; }
        .audio-wave span:nth-child(2) { animation-delay: 0.1s; }
        .audio-wave span:nth-child(3) { animation-delay: 0.2s; }
        .audio-wave span:nth-child(4) { animation-delay: 0.3s; }
        .audio-wave span:nth-child(5) { animation-delay: 0.4s; }
        
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        
        .country-select {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .country-select option {
            background: #1e293b;
            color: white;
        }
        
        .media-preview {
            max-width: 250px;
            max-height: 250px;
            border-radius: 12px;
        }
        
        .voice-msg {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
        }
        
        .progress-bar {
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #3b82f6);
            transition: width 0.1s;
        }
        
        input[type="file"] { display: none; }
        
        .context-menu {
            position: fixed;
            background: #1e293b;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 150px;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }
        
        .context-menu-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .member-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.05);
        }
        
        .voice-recorder {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            border: 2px solid #ef4444;
            border-radius: 20px;
            padding: 20px 30px;
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .voice-recorder.active {
            display: flex;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .admin-table th, .admin-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .admin-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        /* ØµØ¯Ø§ÛŒ Ø²Ù†Ú¯ */
        .ringtone-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #22c55e;
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body class="text-white">
    <div id="app">
        <!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ -->
        <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
            <div class="max-w-md w-full">
                <div class="text-center mb-8">
                    <div class="w-24 h-24 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse-custom">
                        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent">
                        Ù¾ÛŒØ§Ù…â€ŒØ±Ø³Ø§Ù† ØµÙˆØªÛŒ
                    </h1>
                    <p class="text-gray-400 mt-2">Ú†ØªØŒ ØªÙ…Ø§Ø³ ØµÙˆØªÛŒ Ùˆ Ø§Ø´ØªØ±Ø§Ú© Ø±Ø³Ø§Ù†Ù‡</p>
                </div>
                
                <!-- ØªØ¨â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯/Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… -->
                <div class="flex mb-4 bg-white/5 rounded-xl p-1">
                    <button onclick="showAuthTab('register')" id="authTabRegister" class="flex-1 py-2 rounded-lg bg-green-500/20 text-green-400 font-medium transition-all">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
                    <button onclick="showAuthTab('login')" id="authTabLogin" class="flex-1 py-2 rounded-lg text-gray-400 font-medium transition-all">ÙˆØ±ÙˆØ¯</button>
                </div>
                
                <!-- ÙØ±Ù… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… -->
                <div id="registerForm" class="glass rounded-2xl p-6">
                    <div class="mb-4">
                        <label class="block text-sm text-gray-300 mb-2">Ù†Ø§Ù… Ø´Ù…Ø§</label>
                        <input type="text" id="regName" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-green-400 transition-all" maxlength="30">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm text-gray-300 mb-2">Ú©Ø´ÙˆØ±</label>
                        <select id="regCountry" class="country-select w-full px-4 py-3 border border-white/20 rounded-xl focus:outline-none focus:border-green-400 transition-all">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø´ÙˆØ±...</option>
                            <option value="IR">ğŸ‡®ğŸ‡· Ø§ÛŒØ±Ø§Ù†</option>
                            <option value="AF">ğŸ‡¦ğŸ‡« Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†</option>
                            <option value="TR">ğŸ‡¹ğŸ‡· ØªØ±Ú©ÛŒÙ‡</option>
                            <option value="AE">ğŸ‡¦ğŸ‡ª Ø§Ù…Ø§Ø±Ø§Øª</option>
                            <option value="SA">ğŸ‡¸ğŸ‡¦ Ø¹Ø±Ø¨Ø³ØªØ§Ù†</option>
                            <option value="IQ">ğŸ‡®ğŸ‡¶ Ø¹Ø±Ø§Ù‚</option>
                            <option value="DE">ğŸ‡©ğŸ‡ª Ø¢Ù„Ù…Ø§Ù†</option>
                            <option value="GB">ğŸ‡¬ğŸ‡§ Ø§Ù†Ú¯Ù„Ø³ØªØ§Ù†</option>
                            <option value="US">ğŸ‡ºğŸ‡¸ Ø¢Ù…Ø±ÛŒÚ©Ø§</option>
                            <option value="CA">ğŸ‡¨ğŸ‡¦ Ú©Ø§Ù†Ø§Ø¯Ø§</option>
                            <option value="AU">ğŸ‡¦ğŸ‡º Ø§Ø³ØªØ±Ø§Ù„ÛŒØ§</option>
                            <option value="OTHER">ğŸŒ Ø³Ø§ÛŒØ±</option>
                        </select>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm text-gray-300 mb-2">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                        <input type="password" id="regPassword" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ø­Ø¯Ø§Ù‚Ù„ Û´ Ú©Ø§Ø±Ø§Ú©ØªØ±)"
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-green-400 transition-all" minlength="4">
                    </div>
                    
                    <button onclick="register()" class="w-full py-4 bg-gradient-to-r from-green-500 to-blue-500 rounded-xl font-bold text-lg hover:opacity-90 transition-all glow-green">
                        Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…
                    </button>
                </div>
                
                <!-- ÙØ±Ù… ÙˆØ±ÙˆØ¯ -->
                <div id="loginForm" class="glass rounded-2xl p-6 hidden">
                    <div class="mb-4">
                        <label class="block text-sm text-gray-300 mb-2">Ú©Ø¯ Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
                        <input type="text" id="loginCode" placeholder="Ú©Ø¯ Û¸ Ø±Ù‚Ù…ÛŒ"
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white text-center tracking-widest focus:outline-none focus:border-blue-400 transition-all" maxlength="10">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm text-gray-300 mb-2">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                        <input type="password" id="loginPassword" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±"
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-blue-400 transition-all">
                    </div>
                    
                    <button onclick="login()" class="w-full py-4 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl font-bold text-lg hover:opacity-90 transition-all glow-blue">
                        ÙˆØ±ÙˆØ¯
                    </button>
                </div>
                
                <!-- Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ -->
                <div class="mt-6 text-center">
                    <button onclick="showSupport()" class="text-gray-400 hover:text-green-400 transition-all">
                        ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ùˆ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù…Ø§
                    </button>
                </div>
            </div>
        </div>

        <!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ -->
        <div id="mainPage" class="min-h-screen flex flex-col hidden">
            <header class="glass border-b border-white/10 p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div id="myAvatar" class="w-12 h-12 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center font-bold text-lg">?</div>
                        <div>
                            <p id="myName" class="font-medium">Ú©Ø§Ø±Ø¨Ø±</p>
                            <p id="myCode" class="text-xs text-gray-400 cursor-pointer hover:text-green-400" onclick="copyMyCode()">Ú©Ø¯: --------</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="showSupport()" class="p-2 hover:bg-white/10 rounded-lg transition-all text-green-400" title="Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ">
                            ğŸ’¬
                        </button>
                        <button onclick="showSettings()" class="p-2 hover:bg-white/10 rounded-lg transition-all">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                        <button onclick="logout()" class="p-2 hover:bg-red-500/20 rounded-lg transition-all text-red-400">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </header>
            
            <div class="flex border-b border-white/10">
                <button onclick="switchTab('chats')" id="tabChats" class="tab-btn active flex-1 py-3 text-center border-b-2 border-transparent transition-all">ğŸ’¬ Ú†Øªâ€ŒÙ‡Ø§</button>
                <button onclick="switchTab('contacts')" id="tabContacts" class="tab-btn flex-1 py-3 text-center border-b-2 border-transparent transition-all">ğŸ‘¥ Ù…Ø®Ø§Ø·Ø¨ÛŒÙ†</button>
                <button onclick="switchTab('groups')" id="tabGroups" class="tab-btn flex-1 py-3 text-center border-b-2 border-transparent transition-all">ğŸ‘ª Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§</button>
            </div>
            
            <div id="tabContent" class="flex-1 overflow-hidden">
                <div id="chatsTab" class="h-full flex flex-col">
                    <div id="chatsList" class="flex-1 overflow-auto scrollbar-thin p-3">
                        <div class="text-center text-gray-500 py-10">
                            <p>Ù‡Ù†ÙˆØ² Ú†ØªÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>
                        </div>
                    </div>
                </div>
                
                <div id="contactsTab" class="h-full flex flex-col hidden">
                    <div class="p-3 border-b border-white/10">
                        <button onclick="showAddContact()" class="w-full py-3 bg-green-500/20 hover:bg-green-500/30 border border-green-500/50 rounded-xl text-green-400 font-medium transition-all flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø®Ø§Ø·Ø¨ Ø¬Ø¯ÛŒØ¯
                        </button>
                    </div>
                    <div id="contactsList" class="flex-1 overflow-auto scrollbar-thin p-3">
                        <div class="text-center text-gray-500 py-10">
                            <p>Ù…Ø®Ø§Ø·Ø¨ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>
                        </div>
                    </div>
                </div>
                
                <div id="groupsTab" class="h-full flex flex-col hidden">
                    <div class="p-3 border-b border-white/10 flex gap-2">
                        <button onclick="showCreateGroup()" class="flex-1 py-3 bg-green-500/20 hover:bg-green-500/30 border border-green-500/50 rounded-xl text-green-400 font-medium transition-all">âœ¨ Ø³Ø§Ø®Øª Ú¯Ø±ÙˆÙ‡</button>
                        <button onclick="showJoinGroup()" class="flex-1 py-3 bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/50 rounded-xl text-blue-400 font-medium transition-all">ğŸ”— Ø¹Ø¶ÙˆÛŒØª</button>
                    </div>
                    <div id="groupsList" class="flex-1 overflow-auto scrollbar-thin p-3">
                        <div class="text-center text-gray-500 py-10">
                            <p>Ú¯Ø±ÙˆÙ‡ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ØµÙØ­Ù‡ Ú†Øª -->
        <div id="chatPage" class="min-h-screen flex flex-col hidden">
            <header class="glass border-b border-white/10 p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button onclick="closeChat()" class="p-2 hover:bg-white/10 rounded-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                        <div id="chatAvatar" class="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center font-bold">?</div>
                        <div>
                            <p id="chatName" class="font-medium">Ù†Ø§Ù…</p>
                            <p id="chatStatus" class="text-xs text-gray-400">Ø¢ÙÙ„Ø§ÛŒÙ†</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="startCall()" id="callBtn" class="p-3 bg-green-500/20 hover:bg-green-500/30 rounded-full text-green-400 transition-all">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                        </button>
                        <button onclick="showChatMenu(event)" class="p-2 hover:bg-white/10 rounded-lg">â‹®</button>
                    </div>
                </div>
            </header>
            
            <div id="chatMessages" class="flex-1 overflow-auto scrollbar-thin p-4 space-y-3"></div>
            
            <div class="glass border-t border-white/10 p-3">
                <div id="editPreview" class="hidden mb-2 p-2 bg-yellow-500/20 rounded-lg flex items-center justify-between">
                    <span class="text-sm text-yellow-400">Ø¯Ø± Ø­Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´...</span>
                    <button onclick="cancelEdit()" class="text-gray-500 hover:text-white">âœ•</button>
                </div>
                <div class="flex gap-2 items-end">
                    <div class="flex gap-1">
                        <input type="file" id="imageInput" accept="image/*" onchange="sendMedia('image')">
                        <input type="file" id="videoInput" accept="video/*" onchange="sendMedia('video')">
                        <button onclick="document.getElementById('imageInput').click()" class="p-3 hover:bg-white/10 rounded-xl transition-all text-gray-400">ğŸ–¼ï¸</button>
                        <button onclick="document.getElementById('videoInput').click()" class="p-3 hover:bg-white/10 rounded-xl transition-all text-gray-400">ğŸ¬</button>
                        <button onclick="startVoiceRecord()" id="voiceBtn" class="p-3 hover:bg-white/10 rounded-xl transition-all text-gray-400">ğŸ¤</button>
                    </div>
                    <input type="text" id="chatInput" placeholder="Ù¾ÛŒØ§Ù…..." 
                        class="flex-1 px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-green-400 transition-all" maxlength="2000">
                    <button onclick="sendMessage()" class="p-3 bg-gradient-to-r from-green-500 to-blue-500 rounded-xl hover:opacity-90 transition-all">
                        <svg class="w-5 h-5 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Ø±Ú©ÙˆØ±Ø¯Ø± ÙˆÛŒØ³ -->
        <div id="voiceRecorder" class="voice-recorder">
            <div class="audio-wave">
                <span></span><span></span><span></span><span></span><span></span>
            </div>
            <p id="voiceTimer" class="text-xl font-mono text-red-400">00:00</p>
            <audio id="voicePreview" class="w-full hidden" controls></audio>
            <div class="flex gap-3">
                <button onclick="cancelVoice()" class="px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-all">Ø§Ù†ØµØ±Ø§Ù</button>
                <button onclick="stopVoiceRecord()" id="stopVoiceBtn" class="px-6 py-2 bg-red-500 hover:bg-red-600 rounded-lg transition-all">ØªÙˆÙ‚Ù</button>
                <button onclick="sendVoice()" id="sendVoiceBtn" class="px-6 py-2 bg-green-500 hover:bg-green-600 rounded-lg hidden transition-all">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
        </div>

        <!-- ØµÙØ­Ù‡ ØªÙ…Ø§Ø³ -->
        <div id="callPage" class="min-h-screen flex flex-col items-center justify-center hidden" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
            <div class="text-center">
                <div id="callAvatar" class="w-32 h-32 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center text-4xl font-bold mx-auto mb-6 animate-pulse-custom">?</div>
                <h2 id="callName" class="text-2xl font-bold mb-2">Ù†Ø§Ù…</h2>
                <p id="callStatusText" class="text-gray-400 mb-6">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ...</p>
                
                <div id="callWaves" class="audio-wave justify-center mb-6 hidden">
                    <span></span><span></span><span></span><span></span><span></span>
                </div>
                
                <div id="callTimer" class="text-2xl font-mono text-green-400 mb-8 hidden">00:00</div>
                
                <div id="callMembers" class="flex flex-wrap justify-center gap-3 mb-8 hidden"></div>
                
                <div class="flex items-center justify-center gap-6">
                    <button onclick="toggleMute()" id="muteBtn" class="w-14 h-14 rounded-full bg-white/10 border border-white/20 flex items-center justify-center transition-all hover:bg-white/20">
                        <span id="muteIcon">ğŸ¤</span>
                    </button>
                    <button onclick="endCall()" class="w-16 h-16 rounded-full bg-red-500 flex items-center justify-center transition-all hover:bg-red-600 glow-red">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z"></path>
                        </svg>
                    </button>
                    <button onclick="toggleSpeaker()" id="speakerBtn" class="w-14 h-14 rounded-full bg-white/10 border border-white/20 flex items-center justify-center transition-all hover:bg-white/20">
                        <span id="speakerIcon">ğŸ”Š</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† -->
        <div id="adminPage" class="min-h-screen flex flex-col hidden">
            <header class="glass border-b border-white/10 p-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-xl font-bold text-red-400">ğŸ›¡ï¸ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h1>
                    <button onclick="logoutAdmin()" class="px-4 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30">Ø®Ø±ÙˆØ¬</button>
                </div>
            </header>
            
            <div class="p-4">
                <div class="glass rounded-xl p-4 mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">ğŸ‘¥ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h2>
                        <button onclick="refreshAdminUsers()" class="px-4 py-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
                    </div>
                    <div id="adminUsersList" class="overflow-auto max-h-[60vh]"></div>
                </div>
                
                <div class="glass rounded-xl p-4 mb-4">
                    <h2 class="text-lg font-bold mb-4">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</h2>
                    <div id="adminSettings" class="space-y-4">
                        <div id="settingsList"></div>
                        <div class="flex gap-3">
                            <button onclick="addNewSetting()" class="px-4 py-2 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/30">Ø§ÙØ²ÙˆØ¯Ù† ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¬Ø¯ÛŒØ¯</button>
                            <button onclick="loadAdminSettings()" class="px-4 py-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</button>
                            <button onclick="saveAllSettings()" class="px-4 py-2 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/30">Ø°Ø®ÛŒØ±Ù‡ Ù‡Ù…Ù‡</button>
                        </div>
                    </div>
                </div>
                
                <div id="adminStats" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>
        </div>

        <!-- Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ -->
        <div id="incomingCallModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="glass rounded-2xl p-8 max-w-sm w-full text-center slide-up">
                <div id="incomingAvatar" class="w-24 h-24 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center text-3xl font-bold mx-auto mb-4 animate-ring">?</div>
                <h3 id="incomingName" class="text-xl font-bold mb-2">Ù†Ø§Ù…</h3>
                <p id="incomingType" class="text-gray-400 mb-6">ØªÙ…Ø§Ø³ ØµÙˆØªÛŒ ÙˆØ±ÙˆØ¯ÛŒ...</p>
                
                <div class="flex justify-center gap-6">
                    <button onclick="rejectCall()" class="w-16 h-16 rounded-full bg-red-500 flex items-center justify-center transition-all hover:bg-red-600">âœ•</button>
                    <button onclick="acceptCall()" class="w-16 h-16 rounded-full bg-green-500 flex items-center justify-center transition-all hover:bg-green-600 glow-green">ğŸ“</button>
                </div>
            </div>
        </div>

        <div id="addContactModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="glass rounded-2xl p-6 max-w-sm w-full slide-up">
                <h3 class="text-xl font-bold mb-4 text-center">ğŸ‘¤ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø®Ø§Ø·Ø¨</h3>
                <div class="mb-4">
                    <label class="block text-sm text-gray-300 mb-2">Ú©Ø¯ Ú©Ø§Ø±Ø¨Ø±ÛŒ (Û¸ Ø±Ù‚Ù…)</label>
                    <input type="text" id="addContactCode" placeholder="Ù…Ø«Ø§Ù„: 12345678"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white text-center tracking-widest focus:outline-none focus:border-green-400" maxlength="8">
                </div>
                <div class="mb-6">
                    <label class="block text-sm text-gray-300 mb-2">Ù†Ø§Ù… (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                    <input type="text" id="addContactName" placeholder="Ù†Ø§Ù… Ø¯Ù„Ø®ÙˆØ§Ù‡"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-green-400" maxlength="30">
                </div>
                <div class="flex gap-3">
                    <button onclick="addContact()" class="flex-1 py-3 bg-green-500 hover:bg-green-600 rounded-xl font-medium transition-all">Ø§ÙØ²ÙˆØ¯Ù†</button>
                    <button onclick="closeModal('addContactModal')" class="flex-1 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-medium transition-all">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </div>
        </div>

        <div id="createGroupModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="glass rounded-2xl p-6 max-w-sm w-full slide-up">
                <h3 class="text-xl font-bold mb-4 text-center">âœ¨ Ø³Ø§Ø®Øª Ú¯Ø±ÙˆÙ‡</h3>
                <div class="mb-6">
                    <label class="block text-sm text-gray-300 mb-2">Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡</label>
                    <input type="text" id="createGroupName" placeholder="Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:border-green-400" maxlength="30">
                </div>
                <div class="flex gap-3">
                    <button onclick="createGroup()" class="flex-1 py-3 bg-green-500 hover:bg-green-600 rounded-xl font-medium transition-all">Ø³Ø§Ø®Øª</button>
                    <button onclick="closeModal('createGroupModal')" class="flex-1 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-medium transition-all">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </div>
        </div>

        <div id="joinGroupModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="glass rounded-2xl p-6 max-w-sm w-full slide-up">
                <h3 class="text-xl font-bold mb-4 text-center">ğŸ”— Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú¯Ø±ÙˆÙ‡</h3>
                <div class="mb-6">
                    <label class="block text-sm text-gray-300 mb-2">Ú©Ø¯ ÛŒØ§ Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡</label>
                    <input type="text" id="joinGroupCode" placeholder="Ú©Ø¯ Û¸ Ø±Ù‚Ù…ÛŒ ÛŒØ§ Ù†Ø§Ù…"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white text-center focus:outline-none focus:border-blue-400" maxlength="30">
                </div>
                <div class="flex gap-3">
                    <button onclick="joinGroup()" class="flex-1 py-3 bg-blue-500 hover:bg-blue-600 rounded-xl font-medium transition-all">Ø¹Ø¶ÙˆÛŒØª</button>
                    <button onclick="closeModal('joinGroupModal')" class="flex-1 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-medium transition-all">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </div>
        </div>

        <div id="groupManageModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="glass rounded-2xl p-6 max-w-md w-full max-h-[80vh] overflow-auto slide-up">
                <h3 class="text-xl font-bold mb-4 text-center">âš™ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ú¯Ø±ÙˆÙ‡</h3>
                
                <div class="mb-4 p-3 bg-white/5 rounded-xl text-center">
                    <p class="text-sm text-gray-400">Ú©Ø¯ Ú¯Ø±ÙˆÙ‡</p>
                    <p id="groupCodeDisplay" class="text-lg font-mono text-green-400 mt-1">--------</p>
                    <button onclick="copyGroupCode()" class="mt-2 px-4 py-1 bg-white/10 hover:bg-white/20 rounded-lg text-sm">ğŸ“‹ Ú©Ù¾ÛŒ</button>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-300">Ø§Ø¹Ø¶Ø§ (<span id="memberCount">0</span> Ù†ÙØ±)</span>
                        <button onclick="showAddMember()" class="px-3 py-1 bg-green-500/20 text-green-400 rounded-lg text-sm hover:bg-green-500/30">+ Ø§ÙØ²ÙˆØ¯Ù†</button>
                    </div>
                    <div id="groupMembersList" class="max-h-60 overflow-auto"></div>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="startGroupCall()" class="flex-1 py-3 bg-blue-500 hover:bg-blue-600 rounded-xl font-medium transition-all">ğŸ“ ØªÙ…Ø§Ø³ Ú¯Ø±ÙˆÙ‡ÛŒ</button>
                    <button onclick="closeModal('groupManageModal')" class="flex-1 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-medium transition-all">Ø¨Ø³ØªÙ†</button>
                </div>
            </div>
        </div>

        <div id="addMemberModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="glass rounded-2xl p-6 max-w-sm w-full slide-up">
                <h3 class="text-xl font-bold mb-4 text-center">â• Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ø¶Ùˆ</h3>
                <div class="mb-6">
                    <label class="block text-sm text-gray-300 mb-2">Ú©Ø¯ Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
                    <input type="text" id="addMemberCode" placeholder="Ú©Ø¯ Û¸ Ø±Ù‚Ù…ÛŒ"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white text-center tracking-widest focus:outline-none focus:border-green-400" maxlength="8">
                </div>
                <div class="flex gap-3">
                    <button onclick="addMemberToGroup()" class="flex-1 py-3 bg-green-500 hover:bg-green-600 rounded-xl font-medium transition-all">Ø§ÙØ²ÙˆØ¯Ù†</button>
                    <button onclick="closeModal('addMemberModal')" class="flex-1 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-medium transition-all">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </div>
        </div>

        <div id="settingsModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="glass rounded-2xl p-6 max-w-sm w-full slide-up">
                <h3 class="text-xl font-bold mb-4 text-center">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h3>
                
                <div class="space-y-4">
                    <div class="p-4 bg-white/5 rounded-xl text-center">
                        <p class="text-sm text-gray-400 mb-1">Ú©Ø¯ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´Ù…Ø§</p>
                        <p id="settingsCode" class="text-2xl font-mono text-green-400 tracking-widest">--------</p>
                        <button onclick="copyMyCode()" class="mt-2 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm">ğŸ“‹ Ú©Ù¾ÛŒ Ú©Ø¯</button>
                    </div>
                    
                    <div class="p-4 bg-white/5 rounded-xl">
                        <p class="text-sm text-gray-400 mb-2">Ù„ÛŒØ³Øª Ù…Ø³Ø¯ÙˆØ¯Ù‡Ø§</p>
                        <div id="blockedList" class="max-h-40 overflow-auto text-sm"></div>
                    </div>
                </div>
                
                <button onclick="closeModal('settingsModal')" class="w-full mt-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-medium transition-all">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>

        <div id="supportModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="glass rounded-2xl p-6 max-w-sm w-full slide-up text-center">
                <h3 class="text-xl font-bold mb-4">ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</h3>
                
                <div class="space-y-4">
                    <div class="p-4 bg-white/5 rounded-xl">
                        <p class="text-sm text-gray-400 mb-2">Ú©Ø¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ø± Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†</p>
                        <p class="text-2xl font-mono text-green-400">13901390</p>
                        <button onclick="addSupportContact()" class="mt-3 px-4 py-2 bg-green-500/20 text-green-400 rounded-lg text-sm hover:bg-green-500/30">â• Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù…Ø®Ø§Ø·Ø¨ÛŒÙ†</button>
                    </div>
                    
                    <div class="p-4 bg-white/5 rounded-xl">
                        <p class="text-sm text-gray-400 mb-2">ØªÙ„Ú¯Ø±Ø§Ù…</p>
                        <a href="https://t.me/YourUsername" target="_blank" class="text-blue-400 hover:text-blue-300">@YourUsername</a>
                    </div>
                </div>
                
                <button onclick="closeModal('supportModal')" class="w-full mt-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-medium transition-all">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>

        <div id="banModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="glass rounded-2xl p-6 max-w-sm w-full slide-up">
                <h3 class="text-xl font-bold mb-4 text-center text-red-400">ğŸš« Ø¨Ù† Ú©Ø§Ø±Ø¨Ø±</h3>
                <p id="banUserInfo" class="text-center text-gray-300 mb-4"></p>
                
                <div class="mb-4">
                    <label class="block text-sm text-gray-300 mb-2">Ù†ÙˆØ¹ Ø¨Ù†</label>
                    <select id="banType" class="country-select w-full px-4 py-3 border border-white/20 rounded-xl">
                        <option value="0">Ø¯Ø§Ø¦Ù…ÛŒ</option>
                        <option value="1">Û± Ø³Ø§Ø¹Øª</option>
                        <option value="24">Û²Û´ Ø³Ø§Ø¹Øª</option>
                        <option value="168">Û± Ù‡ÙØªÙ‡</option>
                        <option value="720">Û± Ù…Ø§Ù‡</option>
                    </select>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm text-gray-300 mb-2">Ø¯Ù„ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                    <input type="text" id="banReason" placeholder="Ø¯Ù„ÛŒÙ„ Ø¨Ù†"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none" maxlength="100">
                </div>
                
                <div class="flex gap-3">
                    <button onclick="confirmBan()" class="flex-1 py-3 bg-red-500 hover:bg-red-600 rounded-xl font-medium transition-all">Ø¨Ù† Ú©Ø±Ø¯Ù†</button>
                    <button onclick="closeModal('banModal')" class="flex-1 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-medium transition-all">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </div>
        </div>

        <div id="changeCodeModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="glass rounded-2xl p-6 max-w-sm w-full slide-up">
                <h3 class="text-xl font-bold mb-4 text-center text-blue-400">ğŸ”„ ØªØºÛŒÛŒØ± Ú©Ø¯ Ú©Ø§Ø±Ø¨Ø±</h3>
                <p id="changeCodeUserInfo" class="text-center text-gray-300 mb-4"></p>
                
                <div class="mb-6">
                    <label class="block text-sm text-gray-300 mb-2">Ú©Ø¯ Ø¬Ø¯ÛŒØ¯ (Û¸ Ø±Ù‚Ù…)</label>
                    <input type="text" id="newUserCode" placeholder="Ú©Ø¯ Ø¬Ø¯ÛŒØ¯"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none" maxlength="8" pattern="\d{8}">
                </div>
                
                <div class="flex gap-3">
                    <button onclick="confirmChangeCode()" class="flex-1 py-3 bg-blue-500 hover:bg-blue-600 rounded-xl font-medium transition-all">ØªØºÛŒÛŒØ±</button>
                    <button onclick="closeModal('changeCodeModal')" class="flex-1 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-medium transition-all">Ø§Ù†ØµØ±Ø§Ù</button>
                </div>
            </div>
        </div>

        <!-- Context Menu -->
        <div id="contextMenu" class="context-menu hidden"></div>

        <!-- Toast -->
        <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-xl shadow-lg transition-all opacity-0 pointer-events-none z-50">
            <span id="toastMessage"></span>
        </div>
    </div>

    <script>
        // ========== ØªÙ†Ø¸ÛŒÙ…Ø§Øª ==========
        const SAMPLE_RATE = 16000;
        const BUFFER_SIZE = 4096;
        const ADMIN_CODE = "1361649093";
        const SUPPORT_CODE = "13901390";
        
        const getServerUrl = () => {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            return `${protocol}//${window.location.host}/ws`;
        };

        // ========== Ù…ØªØºÛŒØ±Ù‡Ø§ ==========
        let ws = null;
        let currentUser = null;
        let contacts = [];
        let groups = [];
        let chats = {};
        let blockedUsers = [];
        let currentChat = null;
        let currentChatType = null;
        let currentGroupManage = null;
        let editingMessage = null;
        let banTargetCode = null;
        
        // ØªÙ…Ø§Ø³
        let audioContext = null;
        let playbackContext = null;
        let mediaStream = null;
        let scriptProcessor = null;
        let sourceNode = null;
        let isInCall = false;
        let isMuted = false;
        let isSpeakerOn = true;
        let callTimer = null;
        let callSeconds = 0;
        let incomingCallData = null;
        let currentCallType = null;
        let ringtoneInterval = null;
        let ringtoneAudioCtx = null;
        
        // ÙˆÛŒØ³
        let isRecordingVoice = false;
        let voiceRecorder = null;
        let voiceChunks = [];
        let voiceTimerInterval = null;
        let voiceSeconds = 0;
        let recordedVoiceBlob = null;
        let voiceStream = null;

        // ========== ØµØ¯Ø§ÛŒ Ø²Ù†Ú¯ ==========
        function playRingtone() {
            if (ringtoneAudioCtx) return;
            
            ringtoneAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            const playBeep = () => {
                if (!ringtoneAudioCtx) return;
                
                const oscillator = ringtoneAudioCtx.createOscillator();
                const gainNode = ringtoneAudioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ringtoneAudioCtx.destination);
                
                oscillator.frequency.value = 440;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.3;
                
                oscillator.start();
                
                setTimeout(() => {
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ringtoneAudioCtx.currentTime + 0.1);
                    setTimeout(() => oscillator.stop(), 100);
                }, 200);
            };
            
            playBeep();
            ringtoneInterval = setInterval(playBeep, 1000);
        }
        
        function stopRingtone() {
            if (ringtoneInterval) {
                clearInterval(ringtoneInterval);
                ringtoneInterval = null;
            }
            if (ringtoneAudioCtx) {
                ringtoneAudioCtx.close();
                ringtoneAudioCtx = null;
            }
        }

        // ========== ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ==========
        function showToast(msg, duration = 3000) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = msg;
            toast.classList.remove('opacity-0', 'pointer-events-none');
            toast.classList.add('opacity-100');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'pointer-events-none');
                toast.classList.remove('opacity-100');
            }, duration);
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function generateCode() {
            return Math.floor(10000000 + Math.random() * 90000000).toString();
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function saveData() {
            localStorage.setItem('messenger_user', JSON.stringify(currentUser));
            localStorage.setItem('messenger_contacts', JSON.stringify(contacts));
            localStorage.setItem('messenger_groups', JSON.stringify(groups));
            localStorage.setItem('messenger_chats', JSON.stringify(chats));
            localStorage.setItem('messenger_blocked', JSON.stringify(blockedUsers));
        }

        function loadData() {
            try {
                const u = localStorage.getItem('messenger_user');
                const c = localStorage.getItem('messenger_contacts');
                const g = localStorage.getItem('messenger_groups');
                const ch = localStorage.getItem('messenger_chats');
                const b = localStorage.getItem('messenger_blocked');
                if (u) currentUser = JSON.parse(u);
                if (c) contacts = JSON.parse(c);
                if (g) groups = JSON.parse(g);
                if (ch) chats = JSON.parse(ch);
                if (b) blockedUsers = JSON.parse(b);
            } catch(e) {}
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† ==========
        async function requestNotification() {
            if ('Notification' in window && Notification.permission === 'default') {
                await Notification.requestPermission();
            }
        }

        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const n = new Notification(title, { body, icon: '/icon.png', vibrate: [200, 100, 200] });
                n.onclick = () => { window.focus(); n.close(); };
            }
        }

        // ========== Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ==========
        function showAuthTab(tab) {
            if (tab === 'register') {
                document.getElementById('registerForm').classList.remove('hidden');
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('authTabRegister').classList.add('bg-green-500/20', 'text-green-400');
                document.getElementById('authTabRegister').classList.remove('text-gray-400');
                document.getElementById('authTabLogin').classList.remove('bg-blue-500/20', 'text-blue-400');
                document.getElementById('authTabLogin').classList.add('text-gray-400');
            } else {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('authTabLogin').classList.add('bg-blue-500/20', 'text-blue-400');
                document.getElementById('authTabLogin').classList.remove('text-gray-400');
                document.getElementById('authTabRegister').classList.remove('bg-green-500/20', 'text-green-400');
                document.getElementById('authTabRegister').classList.add('text-gray-400');
            }
        }

        async function register() {
            const name = document.getElementById('regName').value.trim();
            const country = document.getElementById('regCountry').value;
            const password = document.getElementById('regPassword').value;
            
            if (!name) { showToast('Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            if (!country) { showToast('Ú©Ø´ÙˆØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
            if (password.length < 4) { showToast('Ø±Ù…Ø² Ø­Ø¯Ø§Ù‚Ù„ Û´ Ú©Ø§Ø±Ø§Ú©ØªØ±'); return; }
            
            const code = generateCode();
            
            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code, name, country, password })
                });
                
                if (!res.ok) {
                    const err = await res.json();
                    showToast(err.detail || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…');
                    return;
                }
                
                currentUser = { code, name, country, password };
                saveData();
                connectToServer();
                showMainPage();
                requestNotification();
                showToast(`Ú©Ø¯ Ø´Ù…Ø§: ${code}`);
            } catch(e) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        async function login() {
            const code = document.getElementById('loginCode').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†
            if (code === ADMIN_CODE) {
                showAdminPage();
                return;
            }
            
            if (!code) { showToast('Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            if (!password) { showToast('Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code, password })
                });
                
                if (!res.ok) {
                    const err = await res.json();
                    showToast(err.detail || 'Ú©Ø¯ ÛŒØ§ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
                    return;
                }
                
                const data = await res.json();
                
                if (data.isAdmin) {
                    showAdminPage();
                    return;
                }
                
                currentUser = { code: data.user.code, name: data.user.name, country: data.user.country, password };
                saveData();
                connectToServer();
                showMainPage();
            } catch(e) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        function logout() {
            if (ws) ws.close();
            currentUser = null;
            contacts = [];
            groups = [];
            chats = {};
            blockedUsers = [];
            localStorage.clear();
            location.reload();
        }

        function showMainPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('chatPage').classList.add('hidden');
            document.getElementById('callPage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            
            document.getElementById('myName').textContent = currentUser.name;
            document.getElementById('myCode').textContent = `Ú©Ø¯: ${currentUser.code}`;
            document.getElementById('myAvatar').textContent = currentUser.name.charAt(0);
            document.getElementById('settingsCode').textContent = currentUser.code;
            
            updateLists();
        }

        function copyMyCode() {
            navigator.clipboard.writeText(currentUser.code).then(() => showToast('Ú©Ø¯ Ú©Ù¾ÛŒ Ø´Ø¯'));
        }

        // ========== Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† ==========
        function showAdminPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('adminPage').classList.remove('hidden');
            refreshAdminUsers();
            loadAdminSettings();
        }

        function logoutAdmin() {
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
        }

        async function refreshAdminUsers() {
            try {
                const res = await fetch(`/api/admin/users?admin_key=${ADMIN_CODE}`);
                const data = await res.json();
                
                document.getElementById('adminStats').innerHTML = `
                    <div class="glass rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-green-400">${data.online}</p>
                        <p class="text-sm text-gray-400">Ø¢Ù†Ù„Ø§ÛŒÙ†</p>
                    </div>
                    <div class="glass rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-blue-400">${data.total}</p>
                        <p class="text-sm text-gray-400">Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p>
                    </div>
                `;
                
                const list = document.getElementById('adminUsersList');
                if (data.users.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-center py-4">Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
                    return;
                }
                
                list.innerHTML = `<table class="admin-table">
                    <thead>
                        <tr class="text-gray-400">
                            <th>Ú©Ø¯</th>
                            <th>Ù†Ø§Ù…</th>
                            <th>Ú©Ø´ÙˆØ±</th>
                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.users.map(u => `
                            <tr>
                                <td class="font-mono">${u.code}</td>
                                <td>${u.name || '-'}</td>
                                <td>${u.country || '-'}</td>
                                <td>
                                    ${u.online ? '<span class="text-green-400">ğŸŸ¢ Ø¢Ù†Ù„Ø§ÛŒÙ†</span>' : '<span class="text-gray-500">Ø¢ÙÙ„Ø§ÛŒÙ†</span>'}
                                    ${u.banned ? '<span class="text-red-400 mr-2">ğŸš« Ø¨Ù†</span>' : ''}
                                </td>
                                <td>
                                    ${u.banned 
                                        ? `<button onclick="unbanUser('${u.code}')" class="px-3 py-1 bg-green-500/20 text-green-400 rounded hover:bg-green-500/30">Ø¢Ø²Ø§Ø¯</button>`
                                        : `<button onclick="showBanModal('${u.code}', '${u.name}')" class="px-3 py-1 bg-red-500/20 text-red-400 rounded hover:bg-red-500/30">Ø¨Ù†</button>`
                                    }
                                    <button onclick="showChangeCodeModal('${u.code}', '${u.name}')" class="px-3 py-1 bg-blue-500/20 text-blue-400 rounded hover:bg-blue-500/30 ml-2">ØªØºÛŒÛŒØ± Ú©Ø¯</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            } catch(e) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª');
            }
        }

        function showBanModal(code, name) {
            banTargetCode = code;
            document.getElementById('banUserInfo').textContent = `${name} (${code})`;
            document.getElementById('banModal').classList.remove('hidden');
        }

        async function confirmBan() {
            const duration = parseInt(document.getElementById('banType').value);
            const reason = document.getElementById('banReason').value;
            
            try {
                await fetch(`/api/admin/ban?admin_key=${ADMIN_CODE}&user_code=${banTargetCode}&duration=${duration}&reason=${encodeURIComponent(reason)}`, { method: 'POST' });
                showToast('Ú©Ø§Ø±Ø¨Ø± Ø¨Ù† Ø´Ø¯');
                closeModal('banModal');
                refreshAdminUsers();
            } catch(e) {
                showToast('Ø®Ø·Ø§');
            }
        }

        async function unbanUser(code) {
            try {
                await fetch(`/api/admin/unban?admin_key=${ADMIN_CODE}&user_code=${code}`, { method: 'POST' });
                showToast('Ú©Ø§Ø±Ø¨Ø± Ø¢Ø²Ø§Ø¯ Ø´Ø¯');
                refreshAdminUsers();
            } catch(e) {
                showToast('Ø®Ø·Ø§');
            }
        }

        let changeCodeTarget = null;

        function showChangeCodeModal(code, name) {
            changeCodeTarget = code;
            document.getElementById('changeCodeUserInfo').textContent = `${name} (${code})`;
            document.getElementById('newUserCode').value = '';
            document.getElementById('changeCodeModal').classList.remove('hidden');
        }

        async function confirmChangeCode() {
            const newCode = document.getElementById('newUserCode').value.trim();
            if (!newCode || newCode.length !== 8 || !/^\d{8}$/.test(newCode)) {
                showToast('Ú©Ø¯ Ø¨Ø§ÛŒØ¯ Û¸ Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/change_code?admin_key=${ADMIN_CODE}&old_code=${changeCodeTarget}&new_code=${newCode}`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showToast('Ú©Ø¯ ØªØºÛŒÛŒØ± ÛŒØ§ÙØª');
                    closeModal('changeCodeModal');
                    refreshAdminUsers();
                } else {
                    showToast(data.error || 'Ø®Ø·Ø§');
                }
            } catch(e) {
                showToast('Ø®Ø·Ø§');
            }
        }

        async function loadAdminSettings() {
            try {
                const res = await fetch(`/api/admin/settings?admin_key=${ADMIN_CODE}`);
                const data = await res.json();
                if (data.settings) {
                    const list = document.getElementById('settingsList');
                    list.innerHTML = '';
                    for (const [key, value] of Object.entries(data.settings)) {
                        const div = document.createElement('div');
                        div.className = 'flex gap-4 items-center mb-2';
                        div.innerHTML = `
                            <input type="text" value="${key}" class="setting-key flex-1 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white" readonly placeholder="Ú©Ù„ÛŒØ¯">
                            <input type="text" value="${value}" class="setting-value flex-1 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white" readonly placeholder="Ù…Ù‚Ø¯Ø§Ø±">
                            <button onclick="editSetting(this)" class="px-3 py-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                            <button onclick="removeSetting(this)" class="px-3 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30">Ø­Ø°Ù</button>
                        `;
                        list.appendChild(div);
                    }
                    showToast('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
                }
            } catch(e) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª');
            }
        }

        function addNewSetting() {
            const list = document.getElementById('settingsList');
            const div = document.createElement('div');
            div.className = 'flex gap-4 items-center mb-2';
            div.innerHTML = `
                <input type="text" class="setting-key flex-1 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white" placeholder="Ú©Ù„ÛŒØ¯">
                <input type="text" class="setting-value flex-1 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white" placeholder="Ù…Ù‚Ø¯Ø§Ø±">
                <button onclick="editSetting(this)" class="px-3 py-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                <button onclick="removeSetting(this)" class="px-3 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30">Ø­Ø°Ù</button>
            `;
            list.appendChild(div);
        }

        function editSetting(btn) {
            const div = btn.parentElement;
            const keyInput = div.querySelector('.setting-key');
            const valueInput = div.querySelector('.setting-value');
            if (btn.textContent === 'ÙˆÛŒØ±Ø§ÛŒØ´') {
                keyInput.readonly = false;
                valueInput.readonly = false;
                btn.textContent = 'Ø°Ø®ÛŒØ±Ù‡';
                btn.className = 'px-3 py-2 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/30';
            } else {
                keyInput.readonly = true;
                valueInput.readonly = true;
                btn.textContent = 'ÙˆÛŒØ±Ø§ÛŒØ´';
                btn.className = 'px-3 py-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30';
            }
        }

        function removeSetting(btn) {
            btn.parentElement.remove();
        }

        async function saveAllSettings() {
            const settings = {};
            const keys = document.querySelectorAll('.setting-key');
            const values = document.querySelectorAll('.setting-value');
            for (let i = 0; i < keys.length; i++) {
                const key = keys[i].value.trim();
                const value = values[i].value.trim();
                if (key) {
                    settings[key] = value;
                }
            }
            
            try {
                const res = await fetch(`/api/admin/settings?admin_key=${ADMIN_CODE}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                if (res.ok) {
                    showToast('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
                    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ADMIN_CODE Ù…Ø­Ù„ÛŒ Ø§Ú¯Ø± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯
                    if (settings.admin_code) {
                        ADMIN_CODE = settings.admin_code;
                    }
                    // Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ùˆ readonly Ú©Ù†
                    document.querySelectorAll('.setting-key, .setting-value').forEach(input => input.readonly = true);
                    document.querySelectorAll('button').forEach(btn => {
                        if (btn.textContent === 'Ø°Ø®ÛŒØ±Ù‡') {
                            btn.textContent = 'ÙˆÛŒØ±Ø§ÛŒØ´';
                            btn.className = 'px-3 py-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30';
                        }
                    });
                } else {
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡');
                }
            } catch(e) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª');
            }
        }

        // ========== WebSocket ==========
        let wsReconnectTimeout = null;
        let isConnecting = false;
        
        function connectToServer() {
            if (isConnecting || (ws && ws.readyState === WebSocket.OPEN)) return;
            
            isConnecting = true;
            const url = `${getServerUrl()}/${currentUser.code}/${encodeURIComponent(currentUser.name)}`;
            
            console.log('ğŸ”Œ Connecting to:', url);
            
            ws = new WebSocket(url);
            ws.binaryType = 'arraybuffer';
            
            ws.onopen = () => {
                console.log('âœ… Connected!');
                isConnecting = false;
                showToast('Ù…ØªØµÙ„ Ø´Ø¯ âœ“', 1500);
                syncData();
            };
            
            ws.onmessage = (event) => {
                if (typeof event.data === 'string') {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('ğŸ“¨ Received:', data.type, data);
                        handleMessage(data);
                    } catch(e) {
                        console.error('Parse error:', e);
                    }
                } else if (isInCall && isSpeakerOn) {
                    playAudio(event.data);
                }
            };
            
            ws.onclose = (e) => {
                console.log('âŒ Disconnected:', e.code, e.reason);
                isConnecting = false;
                
                if (wsReconnectTimeout) clearTimeout(wsReconnectTimeout);
                wsReconnectTimeout = setTimeout(() => {
                    if (currentUser) {
                        console.log('ğŸ”„ Reconnecting...');
                        connectToServer();
                    }
                }, 2000);
            };
            
            ws.onerror = (e) => {
                console.error('âš ï¸ WS Error:', e);
                isConnecting = false;
            };
        }

        function syncData() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({
                type: 'sync',
                contacts: contacts.map(c => c.code),
                groups: groups.map(g => g.code),
                blocked: blockedUsers
            }));
        }

        function handleMessage(data) {
            console.log('ğŸ”” Processing:', data.type);
            
            switch(data.type) {
                case 'banned':
                    showToast('Ø´Ù…Ø§ Ø¨Ù† Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯: ' + (data.reason || ''));
                    logout();
                    break;
                    
                case 'contact_status':
                    console.log(`ğŸ‘¤ ${data.name} is ${data.online ? 'online' : 'offline'}`);
                    updateContactStatus(data.code, data.online, data.name);
                    // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± ØµÙØ­Ù‡ Ú†Øª
                    if (currentChat === data.code && currentChatType === 'contact') {
                        document.getElementById('chatStatus').textContent = data.online ? 'ğŸŸ¢ Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'Ø¢ÙÙ„Ø§ÛŒÙ†';
                    }
                    break;
                    
                case 'message':
                    console.log(`ğŸ’¬ Message from ${data.from}: ${data.text?.slice(0, 30)}`);
                    receiveMessage(data);
                    break;
                    
                case 'group_message':
                    console.log(`ğŸ‘ª Group msg in ${data.groupCode} from ${data.from}`);
                    receiveGroupMessage(data);
                    break;
                    
                case 'media':
                    console.log(`ğŸ“ Media from ${data.from}: ${data.mediaType}`);
                    receiveMedia(data);
                    break;
                    
                case 'message_edited':
                    handleMessageEdited(data);
                    break;
                    
                case 'message_deleted':
                    handleMessageDeleted(data);
                    break;
                    
                case 'incoming_call':
                    console.log('ğŸ“ Incoming call from:', data.callerName);
                    playRingtone();
                    showIncomingCall(data);
                    break;
                    
                case 'call_ringing':
                    console.log('ğŸ”” Call ringing...');
                    playRingtone();
                    document.getElementById('callStatusText').textContent = 'ğŸ”” Ø¯Ø± Ø­Ø§Ù„ Ø²Ù†Ú¯ Ø²Ø¯Ù†...';
                    break;
                    
                case 'call_accepted':
                    console.log('âœ… Call accepted!');
                    stopRingtone();
                    startCallAudio();
                    break;
                    
                case 'call_rejected':
                    console.log('âŒ Call rejected');
                    stopRingtone();
                    endCallCleanup();
                    showToast('ØªÙ…Ø§Ø³ Ø±Ø¯ Ø´Ø¯');
                    break;
                    
                case 'call_ended':
                    console.log('ğŸ“µ Call ended');
                    stopRingtone();
                    endCallCleanup();
                    showToast('ØªÙ…Ø§Ø³ Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØª');
                    break;
                    
                case 'group_call_started':
                    console.log('ğŸ“ Group call started:', data.groupName);
                    playRingtone();
                    showIncomingCall({ ...data, isGroup: true });
                    break;
                    
                case 'call_member_joined':
                    console.log('â• Member joined call:', data.name);
                    addCallMember(data.code, data.name);
                    break;
                    
                case 'call_member_left':
                    console.log('â– Member left call:', data.code);
                    removeCallMember(data.code);
                    break;
                    
                case 'added_to_group_call':
                    console.log('â• Added to group call:', data.groupCode);
                    // Ø´Ø§ÛŒØ¯ Ø§Ø·Ù„Ø§Ø¹ Ø¨Ø¯Ù‡ ÛŒØ§ Ú†ÛŒØ²ÛŒ
                    showToast('Ø¨Ù‡ ØªÙ…Ø§Ø³ Ú¯Ø±ÙˆÙ‡ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ÛŒØ¯');
                    break;
                    
                case 'kicked_from_group_call':
                    console.log('â– Kicked from group call:', data.groupCode);
                    removeCallMember(currentUser.code); // Ø®ÙˆØ¯ Ø±Ø§ Ø­Ø°Ù Ú©Ù†
                    showToast('Ø§Ø² ØªÙ…Ø§Ø³ Ú¯Ø±ÙˆÙ‡ÛŒ Ø§Ø®Ø±Ø§Ø¬ Ø´Ø¯ÛŒØ¯');
                    break;
                    
                case 'group_info':
                    handleGroupInfo(data);
                    break;
                    
                case 'group_updated':
                    updateGroupData(data.group);
                    break;
                    
                case 'kicked':
                    handleKicked(data);
                    break;
                    
                case 'user_info':
                    if (data.name && data.code) {
                        const c = contacts.find(x => x.code === data.code);
                        if (c && !c.customName) c.name = data.name;
                        saveData();
                        updateLists();
                    }
                    break;
            }
        }

        // ========== ÙˆÛŒØ±Ø§ÛŒØ´/Ø­Ø°Ù Ù¾ÛŒØ§Ù… ==========
        function handleMessageEdited(data) {
            const key = data.groupCode ? `group_${data.groupCode}` : `contact_${data.from}`;
            if (chats[key]) {
                const msg = chats[key].find(m => m.id === data.id);
                if (msg) {
                    msg.text = data.text;
                    msg.edited = true;
                    saveData();
                    if (currentChat === (data.groupCode || data.from)) {
                        renderMessages(chats[key]);
                    }
                }
            }
        }

        function handleMessageDeleted(data) {
            const key = data.groupCode ? `group_${data.groupCode}` : `contact_${data.from}`;
            if (chats[key]) {
                chats[key] = chats[key].filter(m => m.id !== data.id);
                saveData();
                if (currentChat === (data.groupCode || data.from)) {
                    renderMessages(chats[key]);
                }
            }
        }

        function startEditMessage(msgId) {
            hideContextMenu();
            const key = `${currentChatType}_${currentChat}`;
            const msg = chats[key]?.find(m => m.id === msgId);
            if (!msg || msg.from !== currentUser.code) return;
            
            editingMessage = msgId;
            document.getElementById('chatInput').value = msg.text || '';
            document.getElementById('editPreview').classList.remove('hidden');
            document.getElementById('chatInput').focus();
        }

        function cancelEdit() {
            editingMessage = null;
            document.getElementById('chatInput').value = '';
            document.getElementById('editPreview').classList.add('hidden');
        }

        function deleteMessage(msgId) {
            hideContextMenu();
            if (!confirm('Ø­Ø°Ù Ù¾ÛŒØ§Ù…ØŸ')) return;
            
            const key = `${currentChatType}_${currentChat}`;
            chats[key] = chats[key].filter(m => m.id !== msgId);
            saveData();
            renderMessages(chats[key]);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'delete_message',
                    to: currentChat,
                    id: msgId,
                    isGroup: currentChatType === 'group'
                }));
            }
        }

        // ========== Ù…Ø®Ø§Ø·Ø¨ÛŒÙ† ==========
        function showAddContact() {
            document.getElementById('addContactModal').classList.remove('hidden');
            document.getElementById('addContactCode').value = '';
            document.getElementById('addContactName').value = '';
        }

        function addContact() {
            const code = document.getElementById('addContactCode').value.trim();
            const name = document.getElementById('addContactName').value.trim();
            
            if (code.length !== 8 || !/^\d+$/.test(code)) { showToast('Ú©Ø¯ Ø¨Ø§ÛŒØ¯ Û¸ Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯'); return; }
            if (code === currentUser.code) { showToast('Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø®ÙˆØ¯ØªØ§Ù† Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯'); return; }
            if (contacts.find(c => c.code === code)) { showToast('Ø§ÛŒÙ† Ù…Ø®Ø§Ø·Ø¨ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡'); return; }
            
            const contact = {
                code,
                name: name || `Ú©Ø§Ø±Ø¨Ø± ${code.slice(-4)}`,
                customName: !!name,
                online: false,
                addedAt: Date.now()
            };
            
            contacts.push(contact);
            saveData();
            updateLists();
            closeModal('addContactModal');
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'add_contact', code }));
            }
            
            showToast('Ù…Ø®Ø§Ø·Ø¨ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
        }

        function addSupportContact() {
            if (contacts.find(c => c.code === SUPPORT_CODE)) {
                showToast('Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡');
                return;
            }
            
            contacts.push({
                code: SUPPORT_CODE,
                name: 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ',
                customName: true,
                online: false,
                addedAt: Date.now()
            });
            saveData();
            updateLists();
            closeModal('supportModal');
            showToast('Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
        }

        function removeContact(code) {
            if (!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
            contacts = contacts.filter(c => c.code !== code);
            saveData();
            updateLists();
            showToast('Ø­Ø°Ù Ø´Ø¯');
        }

        function blockUser(code) {
            if (blockedUsers.includes(code)) return;
            blockedUsers.push(code);
            saveData();
            updateLists();
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'block', code }));
            }
            showToast('Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯');
        }

        function unblockUser(code) {
            blockedUsers = blockedUsers.filter(c => c !== code);
            saveData();
            updateLists();
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'unblock', code }));
            }
            showToast('Ø¢Ø²Ø§Ø¯ Ø´Ø¯');
        }

        function updateContactStatus(code, online, name) {
            const contact = contacts.find(c => c.code === code);
            if (contact) {
                contact.online = online;
                if (name && !contact.customName) contact.name = name;
                updateLists();
            }
        }

        // ========== Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ ==========
        function showCreateGroup() {
            document.getElementById('createGroupModal').classList.remove('hidden');
            document.getElementById('createGroupName').value = '';
        }

        function createGroup() {
            const name = document.getElementById('createGroupName').value.trim();
            if (!name) { showToast('Ù†Ø§Ù… Ú¯Ø±ÙˆÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            
            const group = {
                code: generateCode(),
                name,
                isOwner: true,
                members: [{ code: currentUser.code, name: currentUser.name, isOwner: true }],
                createdAt: Date.now()
            };
            
            groups.push(group);
            saveData();
            updateLists();
            closeModal('createGroupModal');
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'create_group', group }));
            }
            
            showToast(`Ú¯Ø±ÙˆÙ‡ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ - Ú©Ø¯: ${group.code}`);
        }

        function showJoinGroup() {
            document.getElementById('joinGroupModal').classList.remove('hidden');
            document.getElementById('joinGroupCode').value = '';
        }

        function joinGroup() {
            const query = document.getElementById('joinGroupCode').value.trim();
            if (!query) { showToast('Ú©Ø¯ ÛŒØ§ Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'join_group_call', to: query }));
            }
            
            closeModal('joinGroupModal');
            showToast('Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...');
        }

        function handleGroupInfo(data) {
            if (data.error) { showToast(data.error); return; }
            if (groups.find(g => g.code === data.group.code)) { showToast('Ù‚Ø¨Ù„Ø§Ù‹ Ø¹Ø¶Ùˆ Ù‡Ø³ØªÛŒØ¯'); return; }
            
            groups.push({ ...data.group, isOwner: false, joinedAt: Date.now() });
            saveData();
            updateLists();
            showToast(`Ø¨Ù‡ "${data.group.name}" Ù¾ÛŒÙˆØ³ØªÛŒØ¯`);
        }

        function updateGroupData(group) {
            const idx = groups.findIndex(g => g.code === group.code);
            if (idx !== -1) {
                groups[idx] = { ...groups[idx], ...group };
                saveData();
                updateLists();
                if (currentGroupManage === group.code) showGroupManage(group.code);
            }
        }

        function leaveGroup(code) {
            if (!confirm('Ø§Ø² Ú¯Ø±ÙˆÙ‡ Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯ØŸ')) return;
            groups = groups.filter(g => g.code !== code);
            saveData();
            updateLists();
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'leave_group', groupCode: code }));
            }
            showToast('Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯');
        }

        function handleKicked(data) {
            groups = groups.filter(g => g.code !== data.groupCode);
            saveData();
            updateLists();
            if (currentChat === data.groupCode) closeChat();
            showToast(`Ø§Ø² Ú¯Ø±ÙˆÙ‡ "${data.groupName}" Ø§Ø®Ø±Ø§Ø¬ Ø´Ø¯ÛŒØ¯`);
        }

        function showGroupManage(code) {
            const group = groups.find(g => g.code === code);
            if (!group) return;
            
            currentGroupManage = code;
            document.getElementById('groupCodeDisplay').textContent = code;
            document.getElementById('memberCount').textContent = group.members?.length || 1;
            
            const list = document.getElementById('groupMembersList');
            list.innerHTML = (group.members || []).map(m => `
                <div class="member-item">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-sm font-bold">${m.name?.charAt(0) || '?'}</div>
                        <span>${m.name || 'Ú©Ø§Ø±Ø¨Ø±'}</span>
                        ${m.isOwner ? '<span class="text-xs bg-yellow-500/20 text-yellow-400 px-2 py-0.5 rounded">Ù…Ø§Ù„Ú©</span>' : ''}
                        ${m.code === currentUser.code ? '<span class="text-xs text-gray-400">(Ø´Ù…Ø§)</span>' : ''}
                    </div>
                    ${group.isOwner && m.code !== currentUser.code ? `
                        <button onclick="kickMember('${code}', '${m.code}')" class="px-2 py-1 bg-red-500/20 text-red-400 rounded text-sm hover:bg-red-500/30">Ø§Ø®Ø±Ø§Ø¬</button>
                    ` : ''}
                </div>
            `).join('');
            
            document.getElementById('groupManageModal').classList.remove('hidden');
        }

        function showAddMember() {
            document.getElementById('addMemberModal').classList.remove('hidden');
            document.getElementById('addMemberCode').value = '';
        }

        function addMemberToGroup() {
            const code = document.getElementById('addMemberCode').value.trim();
            if (code.length !== 8 || !/^\d+$/.test(code)) { showToast('Ú©Ø¯ Ø¨Ø§ÛŒØ¯ Û¸ Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯'); return; }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'add_member',
                    groupCode: currentGroupManage,
                    memberCode: code
                }));
            }
            
            closeModal('addMemberModal');
            showToast('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
        }

        function kickMember(groupCode, memberCode) {
            if (!confirm('Ø§Ø®Ø±Ø§Ø¬ Ø´ÙˆØ¯ØŸ')) return;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'kick_member',
                    groupCode,
                    memberCode
                }));
            }
        }

        function copyGroupCode() {
            navigator.clipboard.writeText(currentGroupManage).then(() => showToast('Ú©Ø¯ Ú©Ù¾ÛŒ Ø´Ø¯'));
        }

        // ========== Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ ==========
        function updateLists() {
            updateContactsList();
            updateGroupsList();
            updateChatsList();
            updateBlockedList();
        }

        function updateContactsList() {
            const list = document.getElementById('contactsList');
            if (contacts.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-10"><p>Ù…Ø®Ø§Ø·Ø¨ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p></div>';
                return;
            }
            
            list.innerHTML = contacts.filter(c => !blockedUsers.includes(c.code)).map(c => `
                <div class="glass rounded-xl p-3 mb-2 flex items-center gap-3 cursor-pointer hover:bg-white/10 transition-all" onclick="openChat('${c.code}', 'contact')">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center font-bold text-lg relative">
                        ${c.name.charAt(0)}
                        <span class="absolute bottom-0 right-0 ${c.online ? 'online-dot' : 'offline-dot'}"></span>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium">${c.name}</p>
                        <p class="text-xs text-gray-400">${c.online ? 'ğŸŸ¢ Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'Ø¢ÙÙ„Ø§ÛŒÙ†'}</p>
                    </div>
                    <button onclick="event.stopPropagation(); showContactMenu(event, '${c.code}')" class="p-2 hover:bg-white/10 rounded-lg">â‹®</button>
                </div>
            `).join('');
        }

        function updateGroupsList() {
            const list = document.getElementById('groupsList');
            if (groups.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-10"><p>Ú¯Ø±ÙˆÙ‡ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p></div>';
                return;
            }
            
            list.innerHTML = groups.map(g => `
                <div class="glass rounded-xl p-3 mb-2 cursor-pointer hover:bg-white/10 transition-all" onclick="openChat('${g.code}', 'group')">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center font-bold text-lg">ğŸ‘ª</div>
                        <div class="flex-1">
                            <p class="font-medium">${g.name}</p>
                            <p class="text-xs text-gray-400">${g.members?.length || 1} Ø¹Ø¶Ùˆ</p>
                        </div>
                        ${g.isOwner ? '<span class="text-xs bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded">Ù…Ø§Ù„Ú©</span>' : ''}
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="event.stopPropagation(); showGroupManage('${g.code}')" class="flex-1 py-1 bg-white/10 hover:bg-white/20 rounded text-sm">âš™ï¸ Ù…Ø¯ÛŒØ±ÛŒØª</button>
                        <button onclick="event.stopPropagation(); leaveGroup('${g.code}')" class="py-1 px-3 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded text-sm">Ø®Ø±ÙˆØ¬</button>
                    </div>
                </div>
            `).join('');
        }

        function updateChatsList() {
            const list = document.getElementById('chatsList');
            const allChats = [];
            
            contacts.forEach(c => {
                if (blockedUsers.includes(c.code)) return;
                const key = `contact_${c.code}`;
                const msgs = chats[key] || [];
                const last = msgs[msgs.length - 1];
                const unread = msgs.filter(m => !m.read && m.from !== currentUser.code).length;
                
                if (msgs.length > 0) {
                    allChats.push({
                        type: 'contact', code: c.code, name: c.name, online: c.online,
                        lastMessage: last?.text || (last?.mediaType ? `ğŸ“ ${last.mediaType}` : ''),
                        lastTime: last?.time || 0, unread
                    });
                }
            });
            
            groups.forEach(g => {
                const key = `group_${g.code}`;
                const msgs = chats[key] || [];
                const last = msgs[msgs.length - 1];
                const unread = msgs.filter(m => !m.read && m.from !== currentUser.code).length;
                
                allChats.push({
                    type: 'group', code: g.code, name: g.name, members: g.members?.length || 1,
                    lastMessage: last?.text || (last?.mediaType ? `ğŸ“ ${last.mediaType}` : 'Ú¯Ø±ÙˆÙ‡ Ø¬Ø¯ÛŒØ¯'),
                    lastTime: last?.time || g.createdAt, unread
                });
            });
            
            allChats.sort((a, b) => b.lastTime - a.lastTime);
            
            if (allChats.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-10"><p>Ù‡Ù†ÙˆØ² Ú†ØªÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p></div>';
                return;
            }
            
            list.innerHTML = allChats.map(c => `
                <div class="glass rounded-xl p-3 mb-2 flex items-center gap-3 cursor-pointer hover:bg-white/10 transition-all" onclick="openChat('${c.code}', '${c.type}')">
                    <div class="w-12 h-12 bg-gradient-to-br ${c.type === 'group' ? 'from-green-500 to-blue-500' : 'from-blue-400 to-purple-500'} rounded-full flex items-center justify-center font-bold text-lg relative">
                        ${c.type === 'group' ? 'ğŸ‘ª' : c.name.charAt(0)}
                        ${c.type === 'contact' ? `<span class="absolute bottom-0 right-0 ${c.online ? 'online-dot' : 'offline-dot'}"></span>` : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium">${c.name}</p>
                        <p class="text-sm text-gray-400 truncate">${c.lastMessage}</p>
                    </div>
                    ${c.unread > 0 ? `<span class="unread-badge">${c.unread}</span>` : ''}
                </div>
            `).join('');
        }

        function updateBlockedList() {
            const list = document.getElementById('blockedList');
            if (blockedUsers.length === 0) {
                list.innerHTML = '<p class="text-gray-500">Ù‡ÛŒÚ†â€ŒÚ©Ø³ Ù…Ø³Ø¯ÙˆØ¯ Ù†Ø´Ø¯Ù‡</p>';
                return;
            }
            
            list.innerHTML = blockedUsers.map(code => {
                const c = contacts.find(x => x.code === code);
                return `<div class="flex justify-between items-center p-2 bg-white/5 rounded mb-1">
                    <span>${c?.name || code}</span>
                    <button onclick="unblockUser('${code}')" class="text-green-400 text-xs">Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù†</button>
                </div>`;
            }).join('');
        }

        // ========== Ú†Øª ==========
        function openChat(code, type) {
            currentChat = code;
            currentChatType = type;
            
            let info;
            if (type === 'contact') {
                info = contacts.find(c => c.code === code);
            } else {
                info = groups.find(g => g.code === code);
            }
            if (!info) return;
            
            document.getElementById('chatName').textContent = info.name;
            document.getElementById('chatAvatar').textContent = type === 'group' ? 'ğŸ‘ª' : info.name.charAt(0);
            document.getElementById('chatStatus').textContent = type === 'group' 
                ? `${info.members?.length || 1} Ø¹Ø¶Ùˆ` 
                : (info.online ? 'ğŸŸ¢ Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'Ø¢ÙÙ„Ø§ÛŒÙ†');
            
            document.getElementById('callBtn').style.display = 'block';
            
            const key = `${type}_${code}`;
            const msgs = chats[key] || [];
            msgs.forEach(m => m.read = true);
            saveData();
            updateChatsList();
            renderMessages(msgs);
            
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('chatPage').classList.remove('hidden');
            
            setTimeout(() => {
                const container = document.getElementById('chatMessages');
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function closeChat() {
            document.getElementById('chatPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            currentChat = null;
            currentChatType = null;
            cancelEdit();
        }

        function renderMessages(msgs) {
            const container = document.getElementById('chatMessages');
            if (msgs.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-10"><p>Ù¾ÛŒØ§Ù…ÛŒ Ù†ÛŒØ³Øª</p></div>';
                return;
            }
            
            container.innerHTML = msgs.map(m => {
                const isMe = m.from === currentUser.code;
                const time = new Date(m.time).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
                
                let content = '';
                if (m.mediaType === 'image') {
                    content = `<img src="${m.mediaData}" class="media-preview rounded-lg mb-2" onclick="window.open('${m.mediaData}')">`;
                } else if (m.mediaType === 'video') {
                    content = `<video src="${m.mediaData}" class="media-preview rounded-lg mb-2" controls></video>`;
                } else if (m.mediaType === 'voice') {
                    content = `<div class="voice-msg"><button onclick="playVoice(this, '${m.mediaData}')" class="text-2xl">â–¶ï¸</button><div class="flex-1"><div class="progress-bar"><div class="progress-bar-fill" style="width:0%"></div></div></div><span class="text-xs">${m.duration || '0:00'}</span></div>`;
                }
                if (m.text) content += `<p>${escapeHtml(m.text)}</p>`;
                if (m.edited) content += `<span class="text-xs text-gray-500">(ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯Ù‡)</span>`;
                
                return `
                    <div class="flex ${isMe ? 'justify-end' : 'justify-start'} slide-up" oncontextmenu="showMessageMenu(event, '${m.id}', ${isMe})">
                        <div class="message-bubble ${isMe ? 'bg-gradient-to-r from-green-600 to-blue-600 rounded-br-sm' : 'bg-white/10 rounded-bl-sm'} rounded-2xl px-4 py-2">
                            ${!isMe && currentChatType === 'group' ? `<p class="text-xs text-green-400 mb-1">${m.senderName || 'Ú©Ø§Ø±Ø¨Ø±'}</p>` : ''}
                            ${content}
                            <p class="text-xs ${isMe ? 'text-white/60' : 'text-gray-500'} mt-1 text-left">${time}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !currentChat) return;
            
            const msgId = Date.now().toString();
            
            // ÙˆÛŒØ±Ø§ÛŒØ´
            if (editingMessage) {
                const key = `${currentChatType}_${currentChat}`;
                const msg = chats[key]?.find(m => m.id === editingMessage);
                if (msg) {
                    msg.text = text;
                    msg.edited = true;
                    saveData();
                    renderMessages(chats[key]);
                    
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'edit_message',
                            to: currentChat,
                            id: editingMessage,
                            text,
                            isGroup: currentChatType === 'group'
                        }));
                    }
                }
                cancelEdit();
                return;
            }
            
            const msg = {
                id: msgId,
                from: currentUser.code,
                senderName: currentUser.name,
                text,
                time: Date.now(),
                read: true
            };
            
            const key = `${currentChatType}_${currentChat}`;
            if (!chats[key]) chats[key] = [];
            chats[key].push(msg);
            saveData();
            renderMessages(chats[key]);
            input.value = '';
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: currentChatType === 'group' ? 'group_message' : 'message',
                    to: currentChat,
                    id: msgId,
                    text
                }));
            }
        }

        function receiveMessage(data) {
            if (blockedUsers.includes(data.from)) return;
            
            const key = `contact_${data.from}`;
            if (!chats[key]) chats[key] = [];
            
            chats[key].push({
                id: data.id,
                from: data.from,
                senderName: data.senderName,
                text: data.text,
                mediaType: data.mediaType,
                mediaData: data.mediaData,
                duration: data.duration,
                time: data.time || Date.now(),
                read: currentChat === data.from
            });
            
            if (!contacts.find(c => c.code === data.from)) {
                contacts.push({
                    code: data.from,
                    name: data.senderName || `Ú©Ø§Ø±Ø¨Ø± ${data.from.slice(-4)}`,
                    online: true,
                    addedAt: Date.now()
                });
            }
            
            saveData();
            
            if (currentChat === data.from) {
                renderMessages(chats[key]);
            } else {
                updateChatsList();
                showNotification(data.senderName || 'Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯', data.text || 'ğŸ“ Ø±Ø³Ø§Ù†Ù‡');
            }
        }

        function receiveGroupMessage(data) {
            if (blockedUsers.includes(data.from)) return;
            
            const key = `group_${data.groupCode}`;
            if (!chats[key]) chats[key] = [];
            
            chats[key].push({
                id: data.id,
                from: data.from,
                senderName: data.senderName,
                text: data.text,
                mediaType: data.mediaType,
                mediaData: data.mediaData,
                duration: data.duration,
                time: data.time || Date.now(),
                read: currentChat === data.groupCode
            });
            
            saveData();
            
            if (currentChat === data.groupCode) {
                renderMessages(chats[key]);
            } else {
                updateChatsList();
                const g = groups.find(x => x.code === data.groupCode);
                showNotification(g?.name || 'Ú¯Ø±ÙˆÙ‡', `${data.senderName}: ${data.text || 'ğŸ“ Ø±Ø³Ø§Ù†Ù‡'}`);
            }
        }

        // ========== Ø±Ø³Ø§Ù†Ù‡ ==========
        function sendMedia(type) {
            const input = document.getElementById(type === 'image' ? 'imageInput' : 'videoInput');
            const file = input.files[0];
            if (!file || !currentChat) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = e.target.result;
                const msgId = Date.now().toString();
                
                const msg = {
                    id: msgId,
                    from: currentUser.code,
                    senderName: currentUser.name,
                    mediaType: type,
                    mediaData: data,
                    time: Date.now(),
                    read: true
                };
                
                const key = `${currentChatType}_${currentChat}`;
                if (!chats[key]) chats[key] = [];
                chats[key].push(msg);
                saveData();
                renderMessages(chats[key]);
                
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: currentChatType === 'group' ? 'group_media' : 'media',
                        to: currentChat,
                        id: msgId,
                        mediaType: type,
                        mediaData: data
                    }));
                }
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        function receiveMedia(data) {
            if (blockedUsers.includes(data.from)) return;
            
            const key = data.groupCode ? `group_${data.groupCode}` : `contact_${data.from}`;
            if (!chats[key]) chats[key] = [];
            
            chats[key].push({
                id: data.id,
                from: data.from,
                senderName: data.senderName,
                mediaType: data.mediaType,
                mediaData: data.mediaData,
                duration: data.duration,
                time: data.time || Date.now(),
                read: currentChat === (data.groupCode || data.from)
            });
            
            saveData();
            
            const chatCode = data.groupCode || data.from;
            if (currentChat === chatCode) {
                renderMessages(chats[key]);
            } else {
                updateChatsList();
                showNotification(data.senderName || 'Ø±Ø³Ø§Ù†Ù‡ Ø¬Ø¯ÛŒØ¯', `ğŸ“ ${data.mediaType}`);
            }
        }

        // ========== ÙˆÛŒØ³ ==========
        async function startVoiceRecord() {
            if (isRecordingVoice) {
                stopVoiceRecord();
                return;
            }
            
            try {
                voiceStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                voiceRecorder = new MediaRecorder(voiceStream);
                voiceChunks = [];
                voiceSeconds = 0;
                recordedVoiceBlob = null;
                
                voiceRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) voiceChunks.push(e.data);
                };
                
                voiceRecorder.onstop = () => {
                    if (voiceStream) {
                        voiceStream.getTracks().forEach(t => t.stop());
                        voiceStream = null;
                    }
                    
                    if (voiceChunks.length > 0) {
                        recordedVoiceBlob = new Blob(voiceChunks, { type: 'audio/webm' });
                        const url = URL.createObjectURL(recordedVoiceBlob);
                        document.getElementById('voicePreview').src = url;
                        document.getElementById('voicePreview').classList.remove('hidden');
                    }
                    
                    document.getElementById('stopVoiceBtn').classList.add('hidden');
                    document.getElementById('sendVoiceBtn').classList.remove('hidden');
                };
                
                voiceRecorder.start();
                isRecordingVoice = true;
                
                document.getElementById('voiceRecorder').classList.add('active');
                document.getElementById('voicePreview').classList.add('hidden');
                document.getElementById('stopVoiceBtn').classList.remove('hidden');
                document.getElementById('sendVoiceBtn').classList.add('hidden');
                document.getElementById('voiceTimer').textContent = '00:00';
                
                voiceTimerInterval = setInterval(() => {
                    voiceSeconds++;
                    document.getElementById('voiceTimer').textContent = formatTime(voiceSeconds);
                }, 1000);
                
            } catch(e) {
                showToast('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø¯ Ø´Ø¯');
            }
        }

        function stopVoiceRecord() {
            if (voiceRecorder && voiceRecorder.state === 'recording') {
                voiceRecorder.stop();
            }
            isRecordingVoice = false;
            if (voiceTimerInterval) {
                clearInterval(voiceTimerInterval);
                voiceTimerInterval = null;
            }
        }

        function cancelVoice() {
            if (voiceRecorder && voiceRecorder.state === 'recording') {
                voiceRecorder.stop();
            }
            isRecordingVoice = false;
            if (voiceTimerInterval) {
                clearInterval(voiceTimerInterval);
                voiceTimerInterval = null;
            }
            if (voiceStream) {
                voiceStream.getTracks().forEach(t => t.stop());
                voiceStream = null;
            }
            voiceChunks = [];
            recordedVoiceBlob = null;
            voiceSeconds = 0;
            document.getElementById('voiceRecorder').classList.remove('active');
            document.getElementById('voicePreview').classList.add('hidden');
        }

        function sendVoice() {
            if (!recordedVoiceBlob || !currentChat) {
                cancelVoice();
                return;
            }
            
            const duration = formatTime(voiceSeconds);
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = e.target.result;
                const msgId = Date.now().toString();
                
                const msg = {
                    id: msgId,
                    from: currentUser.code,
                    senderName: currentUser.name,
                    mediaType: 'voice',
                    mediaData: data,
                    duration,
                    time: Date.now(),
                    read: true
                };
                
                const key = `${currentChatType}_${currentChat}`;
                if (!chats[key]) chats[key] = [];
                chats[key].push(msg);
                saveData();
                renderMessages(chats[key]);
                
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: currentChatType === 'group' ? 'group_media' : 'media',
                        to: currentChat,
                        id: msgId,
                        mediaType: 'voice',
                        mediaData: data,
                        duration
                    }));
                }
                
                cancelVoice();
            };
            reader.readAsDataURL(recordedVoiceBlob);
        }

        function playVoice(btn, src) {
            const audio = new Audio(src);
            const progress = btn.parentElement.querySelector('.progress-bar-fill');
            
            audio.ontimeupdate = () => {
                const pct = (audio.currentTime / audio.duration) * 100;
                progress.style.width = pct + '%';
            };
            audio.onended = () => {
                btn.textContent = 'â–¶ï¸';
                progress.style.width = '0%';
            };
            
            if (btn.textContent === 'â–¶ï¸') {
                audio.play();
                btn.textContent = 'â¸ï¸';
            } else {
                audio.pause();
                btn.textContent = 'â–¶ï¸';
            }
        }

        // ========== ØªÙ…Ø§Ø³ ==========
        async function startCall() {
            if (!currentChat) return;
            
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: true, noiseSuppression: true, sampleRate: SAMPLE_RATE }
                });
                
                const info = currentChatType === 'group' 
                    ? groups.find(g => g.code === currentChat)
                    : contacts.find(c => c.code === currentChat);
                
                document.getElementById('callName').textContent = info?.name || 'ØªÙ…Ø§Ø³';
                document.getElementById('callAvatar').textContent = currentChatType === 'group' ? 'ğŸ‘ª' : (info?.name?.charAt(0) || '?');
                document.getElementById('callStatusText').textContent = 'ğŸ”” Ø¯Ø± Ø­Ø§Ù„ Ø²Ù†Ú¯ Ø²Ø¯Ù†...';
                document.getElementById('callTimer').classList.add('hidden');
                document.getElementById('callWaves').classList.add('hidden');
                document.getElementById('callMembers').classList.add('hidden');
                
                currentCallType = currentChatType;
                
                document.getElementById('chatPage').classList.add('hidden');
                document.getElementById('callPage').classList.remove('hidden');
                
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: currentChatType === 'group' ? 'group_call' : 'call_request',
                        to: currentChat
                    }));
                }
            } catch(e) {
                showToast('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø¯ Ø´Ø¯');
            }
        }

        function showIncomingCall(data) {
            incomingCallData = data;
            document.getElementById('incomingName').textContent = data.callerName || data.groupName || 'ØªÙ…Ø§Ø³';
            document.getElementById('incomingAvatar').textContent = data.isGroup ? 'ğŸ‘ª' : (data.callerName?.charAt(0) || '?');
            document.getElementById('incomingType').textContent = data.isGroup ? 'ØªÙ…Ø§Ø³ Ú¯Ø±ÙˆÙ‡ÛŒ...' : 'ØªÙ…Ø§Ø³ ØµÙˆØªÛŒ...';
            document.getElementById('incomingCallModal').classList.remove('hidden');
            showNotification('ğŸ“ ØªÙ…Ø§Ø³ ÙˆØ±ÙˆØ¯ÛŒ', data.callerName || data.groupName || 'Ú©Ø§Ø±Ø¨Ø±');
        }

        async function acceptCall() {
            if (!incomingCallData) return;
            
            stopRingtone();
            
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: true, noiseSuppression: true, sampleRate: SAMPLE_RATE }
                });
                
                document.getElementById('callName').textContent = incomingCallData.callerName || incomingCallData.groupName || 'ØªÙ…Ø§Ø³';
                document.getElementById('callAvatar').textContent = incomingCallData.isGroup ? 'ğŸ‘ª' : (incomingCallData.callerName?.charAt(0) || '?');
                
                currentChat = incomingCallData.callerCode || incomingCallData.groupCode;
                currentCallType = incomingCallData.isGroup ? 'group' : 'contact';
                
                document.getElementById('incomingCallModal').classList.add('hidden');
                document.getElementById('mainPage').classList.add('hidden');
                document.getElementById('chatPage').classList.add('hidden');
                document.getElementById('callPage').classList.remove('hidden');
                
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: incomingCallData.isGroup ? 'join_group_call' : 'call_accept',
                        to: currentChat
                    }));
                }
                
                startCallAudio();
            } catch(e) {
                showToast('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø¯ Ø´Ø¯');
                rejectCall();
            }
        }

        function rejectCall() {
            stopRingtone();
            if (incomingCallData && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'call_reject',
                    to: incomingCallData.callerCode || incomingCallData.groupCode
                }));
            }
            document.getElementById('incomingCallModal').classList.add('hidden');
            incomingCallData = null;
        }

        function startCallAudio() {
            isInCall = true;
            document.getElementById('callStatusText').textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ù…Ú©Ø§Ù„Ù…Ù‡';
            document.getElementById('callTimer').classList.remove('hidden');
            document.getElementById('callWaves').classList.remove('hidden');
            
            if (currentCallType === 'group') {
                document.getElementById('callMembers').classList.remove('hidden');
            }
            
            callSeconds = 0;
            callTimer = setInterval(() => {
                callSeconds++;
                document.getElementById('callTimer').textContent = formatTime(callSeconds);
            }, 1000);
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
            playbackContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
            
            sourceNode = audioContext.createMediaStreamSource(mediaStream);
            scriptProcessor = audioContext.createScriptProcessor(BUFFER_SIZE, 1, 1);
            
            scriptProcessor.onaudioprocess = (e) => {
                if (!isMuted && ws && ws.readyState === WebSocket.OPEN) {
                    const input = e.inputBuffer.getChannelData(0);
                    const pcm = new Int16Array(input.length);
                    for (let i = 0; i < input.length; i++) {
                        const s = Math.max(-1, Math.min(1, input[i]));
                        pcm[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }
                    ws.send(pcm.buffer);
                }
            };
            
            sourceNode.connect(scriptProcessor);
            scriptProcessor.connect(audioContext.destination);
        }

        function playAudio(buffer) {
            try {
                if (!playbackContext) return;
                const int16 = new Int16Array(buffer);
                const float32 = new Float32Array(int16.length);
                for (let i = 0; i < int16.length; i++) {
                    float32[i] = int16[i] / (int16[i] < 0 ? 0x8000 : 0x7FFF);
                }
                const audioBuffer = playbackContext.createBuffer(1, float32.length, SAMPLE_RATE);
                audioBuffer.getChannelData(0).set(float32);
                const source = playbackContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(playbackContext.destination);
                source.start();
            } catch(e) {}
        }

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('muteIcon').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ¤';
            document.getElementById('muteBtn').classList.toggle('bg-red-500/30', isMuted);
        }

        function toggleSpeaker() {
            isSpeakerOn = !isSpeakerOn;
            document.getElementById('speakerIcon').textContent = isSpeakerOn ? 'ğŸ”Š' : 'ğŸ”ˆ';
            document.getElementById('speakerBtn').classList.toggle('bg-red-500/30', !isSpeakerOn);
        }

        function endCall() {
            stopRingtone();
            if (ws && ws.readyState === WebSocket.OPEN && currentChat) {
                ws.send(JSON.stringify({
                    type: currentCallType === 'group' ? 'leave_group_call' : 'call_end',
                    to: currentChat
                }));
            }
            endCallCleanup();
        }

        function endCallCleanup() {
            isInCall = false;
            isMuted = false;
            isSpeakerOn = true;
            
            if (callTimer) { clearInterval(callTimer); callTimer = null; }
            if (mediaStream) { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; }
            if (scriptProcessor) { try { scriptProcessor.disconnect(); } catch(e) {} }
            if (sourceNode) { try { sourceNode.disconnect(); } catch(e) {} }
            if (audioContext) { audioContext.close(); audioContext = null; }
            if (playbackContext) { playbackContext.close(); playbackContext = null; }
            
            document.getElementById('callPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            
            document.getElementById('muteIcon').textContent = 'ğŸ¤';
            document.getElementById('speakerIcon').textContent = 'ğŸ”Š';
            document.getElementById('muteBtn').classList.remove('bg-red-500/30');
            document.getElementById('speakerBtn').classList.remove('bg-red-500/30');
            document.getElementById('callMembers').innerHTML = '';
        }

        function addCallMember(code, name) {
            const container = document.getElementById('callMembers');
            if (document.getElementById(`member_${code}`)) return;
            container.innerHTML += `<div id="member_${code}" class="flex flex-col items-center">
                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-blue-500 rounded-full flex items-center justify-center font-bold">${name?.charAt(0) || '?'}</div>
                <span class="text-xs mt-1">${name || 'Ú©Ø§Ø±Ø¨Ø±'}</span>
            </div>`;
        }

        function removeCallMember(code) {
            const el = document.getElementById(`member_${code}`);
            if (el) el.remove();
        }

        function startGroupCall() {
            closeModal('groupManageModal');
            openChat(currentGroupManage, 'group');
            setTimeout(startCall, 300);
        }

        // ========== Ù…Ù†ÙˆÙ‡Ø§ ==========
        function showContactMenu(e, code) {
            e.preventDefault();
            e.stopPropagation();
            const menu = document.getElementById('contextMenu');
            menu.innerHTML = `
                <div class="context-menu-item" onclick="openChat('${code}', 'contact'); hideContextMenu();">ğŸ’¬ Ú†Øª</div>
                <div class="context-menu-item" onclick="hideContextMenu(); currentChat='${code}'; currentChatType='contact'; startCall();">ğŸ“ ØªÙ…Ø§Ø³</div>
                <div class="context-menu-item" onclick="blockUser('${code}'); hideContextMenu();">ğŸš« Ù…Ø³Ø¯ÙˆØ¯</div>
                <div class="context-menu-item text-red-400" onclick="removeContact('${code}'); hideContextMenu();">ğŸ—‘ï¸ Ø­Ø°Ù</div>
            `;
            menu.style.left = Math.min(e.clientX, window.innerWidth - 160) + 'px';
            menu.style.top = e.clientY + 'px';
            menu.classList.remove('hidden');
        }

        function showChatMenu(e) {
            e.preventDefault();
            const menu = document.getElementById('contextMenu');
            let items = '';
            
            if (currentChatType === 'contact') {
                items = `
                    <div class="context-menu-item" onclick="blockUser('${currentChat}'); closeChat(); hideContextMenu();">ğŸš« Ù…Ø³Ø¯ÙˆØ¯</div>
                    <div class="context-menu-item text-red-400" onclick="removeContact('${currentChat}'); closeChat(); hideContextMenu();">ğŸ—‘ï¸ Ø­Ø°Ù</div>
                `;
            } else {
                items = `
                    <div class="context-menu-item" onclick="hideContextMenu(); showGroupManage('${currentChat}');">âš™ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ú¯Ø±ÙˆÙ‡</div>
                    <div class="context-menu-item text-red-400" onclick="leaveGroup('${currentChat}'); closeChat(); hideContextMenu();">ğŸšª Ø®Ø±ÙˆØ¬</div>
                `;
            }
            
            menu.innerHTML = items;
            menu.style.left = Math.min(e.clientX, window.innerWidth - 160) + 'px';
            menu.style.top = e.clientY + 'px';
            menu.classList.remove('hidden');
        }

        function showMessageMenu(e, msgId, isMe) {
            e.preventDefault();
            const menu = document.getElementById('contextMenu');
            
            if (isMe) {
                menu.innerHTML = `
                    <div class="context-menu-item" onclick="startEditMessage('${msgId}')">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</div>
                    <div class="context-menu-item text-red-400" onclick="deleteMessage('${msgId}')">ğŸ—‘ï¸ Ø­Ø°Ù</div>
                `;
            } else {
                menu.innerHTML = `<div class="context-menu-item text-gray-500">Ù¾ÛŒØ§Ù… Ø¯ÛŒÚ¯Ø±Ø§Ù†</div>`;
            }
            
            menu.style.left = Math.min(e.clientX, window.innerWidth - 160) + 'px';
            menu.style.top = e.clientY + 'px';
            menu.classList.remove('hidden');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.add('hidden');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.context-menu')) hideContextMenu();
        });

        // ========== ØªØ¨â€ŒÙ‡Ø§ ==========
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            
            document.getElementById('chatsTab').classList.add('hidden');
            document.getElementById('contactsTab').classList.add('hidden');
            document.getElementById('groupsTab').classList.add('hidden');
            document.getElementById(`${tab}Tab`).classList.remove('hidden');
        }

        function showSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function showSupport() {
            document.getElementById('supportModal').classList.remove('hidden');
        }

        // ========== Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ==========
        document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        document.getElementById('loginPassword').addEventListener('keypress', (e) => { if (e.key === 'Enter') login(); });

        // ========== Ø´Ø±ÙˆØ¹ ==========
        loadData();
        if (currentUser && currentUser.code) {
            connectToServer();
            showMainPage();
        }
    </script>
</body>
</html>